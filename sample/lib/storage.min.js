/*!
 * Storage.js JavaScript Library v0.1.0
 * https://github.com/lcavadas/Storage.js
 *
 * Copyright 2012, LuÃ­s Serralheiro
 */
var storage=function(e,o){var n={sequencialActionCallbackWrapper:function(e,o,n){var t=0,r=e.length,c=function(){r>t?o(e[t++]):n()};return{next:c}},multipleActionCallbackWrapper:function(e,o){var n=[];return{countDown:function(t){n.push(t),n.length===e&&o(n)}}}},t=function(o){o?e({set:function(e,n,t){o.set(e,n,t)},setAll:function(e,n,t){o.setAll(e,n,t)},get:function(e,n,t){o.get(e,n,t)},getAll:function(e,n){o.getAll(e,n)},remove:function(e,n,t){o.remove(e,n,t)},removeAll:function(e,n){o.removeAll(e,n)},ready:function(e){o.ready(e)},close:o.close}):e()};switch(o){case"LocalStorage":storage.KeyValue(t,n);break;case"SessionStorage":storage.KeyValue(t,n,!0);break;case"WebSQL":storage.WebSQL(t,n);break;case"IndexedDB":storage.IndexedDB(t,n);break;default:window.openDatabase?(window.console.log("Using WebSQL"),storage.WebSQL(t,n)):window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.msIndexedDB?(window.console.log("Using IndexedDB"),storage.IndexedDB(t,n)):(window.console.log("Using LocalStorage"),storage.KeyValue(t,n))}};storage.KeyValue=function(e,o,n){try{var t=n?sessionStorage:localStorage}catch(r){return void e()}var c=function(e,o,n){for(var r=JSON.parse(t.getItem(e)),c=r.length,i=0;c>i;i++)if(r[i].id===o)return void n(r[i]);n()},i=function(e,o,n){for(var r=JSON.parse(t.getItem(e))||[],c=!1,i=r.length,a=0;i>a;a++)r[a].id===o.id&&(c=!0,r[a]=o);c||r.push(o),t.setItem(e,JSON.stringify(r)),n()},a=function(e,o){for(var n=JSON.parse(t.getItem(e)),r=n.length,c=0;r>c;c++)if(n[c].id===o)return n.splice(c,1),void t.setItem(e,JSON.stringify(n))};e({set:i,setAll:function(e,n,t){var r=o.multipleActionCallbackWrapper(n.length,t);n.forEach(function(o){i(e,o,r.countDown)})},get:c,getAll:function(e,o){var n=t.getItem(e);o(n?JSON.parse(n):[])},remove:function(e,o,n){a(e,o),n()},removeAll:function(e,o){t.removeItem(e),o()},close:function(){}})},storage.WebSQL=function(e,o){var n,t=function(e,o){n.transaction(function(n){n.executeSql("CREATE TABLE if not exists "+e+"(id TEXT NOT NULL, value TEXT, PRIMARY KEY(id));",[],o,function(e,o){window.console.log("Oops.  Error was "+o.message+" (Code "+o.code+")",o)})})},r=function(e,o,c){n.transaction(function(n){n.executeSql("INSERT OR REPLACE into "+e+"(id, value) VALUES ( ?, ? );",[o.id,JSON.stringify(o)],function(){c()},function(n,i){5===i.code?(window.console.log("WebSQL: going to create table "+e),t(e,function(){window.console.log("WebSQL: created table "+e),r(e,o,c)})):(window.console.log("WebSQL Error: "+i.message+" (Code "+i.code+")",i),c())})})},c=function(e,o,t){n.transaction(function(n){n.executeSql("select value from "+e+" where id=?;",[o],function(e,o){t(o.rows.length>0?JSON.parse(o.rows.item(0).value):void 0)},function(e,o){5===o.code?t():(window.console.log("WebSQL Error: "+o.message+" (Code "+o.code+")",o),t())})})},i=function(e,o){n.transaction(function(n){n.executeSql("select value from "+e,[],function(e,n){for(var t=[],r=n.rows.length,c=0;r>c;c++)t.push(JSON.parse(n.rows.item(c).value));o(t)},function(e,n){5===n.code?o([]):(window.console.log("WebSQL Error: "+n.message+" (Code "+n.code+")",n),o())})})},a=function(e,o,t){n.transaction(function(n){n.executeSql("delete from "+e+" where id=?",[o],t,function(e,o){window.console.log("WebSQL Error: "+o.message+" (Code "+o.code+")",o),t()})})},s=function(e,o){n.transaction(function(n){n.executeSql("drop table "+e,[],o,o)})};try{if(window.openDatabase){var d="storage.js",l="1.0",u="storage.js database",g=65536;n=openDatabase(d,l,u,g),e({set:r,setAll:function(e,n,t){var c=o.multipleActionCallbackWrapper(n.length,t);n.forEach(function(o){r(e,o,c.countDown)})},get:c,getAll:i,remove:a,removeAll:s,close:function(){}})}else window.console.log("SQL Database not supported"),e()}catch(f){window.console.log(2===f?"Invalid database version.":"Unknown error "+f+".")}},storage.IndexedDB=function(e,o){var n,t=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.msIndexedDB,r=function(e,o){n.close();var r=t.open("storage_js",(new Date).getTime());r.onupgradeneeded=function(){n=r.result,n.createObjectStore(e,{keyPath:"id"})},r.onsuccess=function(){o()}},c=function(e,o,t){try{if(!n.objectStoreNames.contains(e))return window.console.log("IndexedDB: going to create objectStore "+e),void r(e,function(){window.console.log("IndexedDB: created objectStore "+e),c(e,o,t)});var i=n.transaction([e],"readwrite"),a=i.objectStore(e),s=a.put(o);i.onerror=function(e){window.console.log("IndexedDB Error: "+e.message+" (Code "+e.code+")",e)},s.onsuccess=function(){t()},s.onerror=function(e){window.console.log("IndexedDB Error: "+e.message+" (Code "+e.code+")",e)}}catch(d){3!==d.code&&8!==d.code?(window.console.log("IndexedDB Error: "+d.message+" (Code "+d.code+")",d),t()):(window.console.log("IndexedDB: going to create objectStore "+e),r(e,function(){c(e,o,t)}))}},i=function(e,o,t){try{var r=n.transaction([e],"readwrite");r.onerror=function(e){window.console.log("IndexedDB Error: "+e.message+" (Code "+e.code+")",e)};var c=r.objectStore(e);c.get(o).onsuccess=function(e){t(e.target.result)}}catch(i){window.console.log("IndexedDB Error: "+i.message+" (Code "+i.code+")",i),t()}},a=function(e,o){try{var t=[],r=n.transaction([e],"readwrite");r.onerror=function(e){window.console.log("IndexedDB Error: "+e.message+" (Code "+e.code+")",e)};var c=r.objectStore(e);c.openCursor().onsuccess=function(e){var n=e.target.result;n?(t.push(n.value),n["continue"]()):o(t)}}catch(i){o([])}},s=function(e,o,t){var r=n.transaction([e],"readwrite"),c=r.objectStore(e);c["delete"](o).onsuccess=function(){t()}},d=function(e,o){n.close();var r=t.open("storage_js",(new Date).getTime());r.onupgradeneeded=function(){try{n=r.result,n.objectStoreNames.contains(e)&&n.deleteObjectStore(e),o()}catch(t){3!==t.code&&8!==t.code?window.console.log("IndexedDB Error: "+t.message+" (Code "+t.code+")",t):o()}}},l=function(){n.close()};if(t){var u=t.open("storage_js");u.onupgradeneeded=function(){window.console.log("UPGRADE NEEDED")},u.onsuccess=function(){n=u.result,e({set:c,setAll:function(e,n,t){var r=o.sequencialActionCallbackWrapper(n,function(o){c(e,o,r.next)},t);r.next()},get:i,getAll:a,remove:s,removeAll:d,close:l})},u.onerror=function(o){window.console.log("An error ocurred",o),e()}}else e()},window.storage=storage;