/*!
 * Arenite JavaScript Library v0.0.16
 * https://github.com/lcavadas/arenite
 *
 * Copyright 2014, LuÃ­s Serralheiro
 */
Arenite=function(n){var e=new Arenite.Object(e);e=e.object.extend(e,new Arenite.Async),e=e.object.extend(e,new Arenite.Url),e=e.object.extend(e,new Arenite.DI(e)),e=e.object.extend(e,new Arenite.AnnotationProcessor(e)),e=e.object.extend(e,new Arenite.Context(e)),e=e.object.extend(e,new Arenite.Loader(e)),e.di.init(n)},Arenite.AnnotationProcessor=function(arenite){var _processAnnotations=function(n){for(var e,t=/@arenite-instance\s+["']([^"']+)["']\s*(.*);\s*(@arenite-init\s+["']([^"']+)["']\s*(.*);)*\s*(@arenite-start\s+["']([^"']+)["']\s*(.*);)*\s*\*\/\s*([\w.]+)/g;e=t.exec(n);)_processAnnotation(e)},_processArgAnnotation=function(match){var args=[],split=match.split(",");return split.forEach(function(arg){var argPair=arg.split(":"),argObj={};argObj[argPair[0].trim()]="ref"===argPair[0].trim()?argPair[1].trim():eval(argPair[1].trim()),args.push(argObj)}),args},_processAnnotation=function(n){var e=n[1],t=n[9];if(arenite.config.context||(arenite.config.context={instances:{}}),arenite.config.context.instances[e]={namespace:t},n[2]&&(arenite.config.context.instances[e].args=_processArgAnnotation(n[2])),n[4]&&(arenite.config.context.instances[e].init={func:n[4]},n[5]&&(arenite.config.context.instances[e].init.args=_processArgAnnotation(n[5]))),n[7]){var o={instance:e,func:n[7]};n[8]&&(o.args=_processArgAnnotation(n[8])),arenite.config.context.start||(arenite.config.context.start=[]),arenite.config.context.start.push(o)}};return{annotation:{processAnnotations:_processAnnotations}}},Arenite.Async=function(){var n=function(n,e,t){var o=0,r=n.length,i=function(){r>o?e(n[o++]):t()};return{next:i}},e=function(n,e,t){var o=t||(new Date).getTime();window.console.groupCollapsed('Latch: Starting latch "'+o+'" for',n,"times"),window.console.trace(),window.console.groupEnd();var r=0;return{countDown:function(){r++,window.console.log('Latch: Counting down latch "'+o+'" ,',n-r,"remaining"),r===n&&(window.console.log('Latch: Triggering latch "'+o+'"'),e(r))},countUp:function(){r--,window.console.log('Latch: Counting up latch "'+o+'" ,',n-r,"remaining"),r===n&&(window.console.log('Latch: Triggering latch "'+o+'"'),e(r))}}};return{async:{seqLatch:function(e,t,o){return new n(e,t,o)},latch:function(n,t,o){return new e(n,t,o)}}}},Arenite.Context=function(n){var e={},t={},o=function(n,o,r,i){e[n]=o,r&&(t[n]=i||[])},r=function(t){n.object["delete"](e,t)},i=function(o){if(t.hasOwnProperty(o)){var r=n.di.resolveArgs({factory:!0,args:t[o]});if(r)return e[o].apply(e[o],r);throw'Unable to resolve arguments for "'+o+'"'}return e[o]};return{context:{get:i,add:o,remove:r}}},Arenite.DI=function(n){var e=function(e){var t=e.func;return t="function"==typeof e.func?e.func:e.extension?n.object.get(n[e.instance],e.func):n.object.get(n.context.get(e.instance),e.func)},t=function(e,t){if(!e.args)return[];var o=!1,r=[];return e.args.forEach(function(t,i){if("undefined"!=typeof t.value)r.push(t.value);else if("undefined"!=typeof t.ref){var c=n.context.get(t.ref);c?r.push(c):o=!0}else if("undefined"!=typeof t.func)r.push(t.func);else if("undefined"!=typeof t.exec)r.push(t.exec(n));else if("undefined"!=typeof t.instance){var s={instances:{}},f="__anonymous_temp_instance__"+(new Date).getTime();s.instances[f]=t.instance,a(s),r.push(n.context.get(f)),e.factory?n.context.remove(f):e.args[i]={ref:f}}}),e.wait&&"function"==typeof t&&r.push(t),o?null:r},o=function(n,o,r){var i=e(n);if(!i)throw'Unknown function "'+n.func+'" for instance "'+n.instance+'"';var c=t(n,r);if(!c)throw'Unable to resolve arguments for "'+n.func+'" of instance "'+n.instance+'"';n.wait&&"function"==typeof o&&o(),i.apply(i,c)},r=function(e,o){if(e){var i=n.object.keys(e),c={};i.forEach(function(r){var i=n.object.get(window,e[r].namespace);if(!i)throw'Unknown function "'+e[r].namespace+'"';var a=e[r].factory?e[r].args||[]:t(e[r]);if(a){var s=e[r].factory?i:i.apply(i,a);if("extension"===o){var f={};f[r]=s,n=n.object.extend(n,f)}else n.context.add(r,s,e[r].factory,e[r].args||[])}else c[r]=e[r]});var a=n.object.keys(c);if(a.length!==n.object.keys(e).length&&a.length>0)r(c);else if(0!==a.length)throw"Make sure you don't have circular dependencies, Unable to resolve the following instances: "+a.join(", ")}},i=function(e,t,r){n.object.keys(e).forEach(function(i){e[i].init&&("string"==typeof e[i].init&&(e[i].init={func:e[i].init}),o(n.object.extend({instance:i,extension:r},e[i].init),function(){t.countUp()},function(){t.countDown()}))})},c=function(n){n&&("complete"!==document.readyState?window.setTimeout(function(){c(n)},100):n.forEach(function(n){o(n)}))},a=function(e){if(window.console.time("Arenite context load"),e){var t=n.async.latch(1,function(){window.console.timeEnd("Arenite context load"),c(e.start)},"instances"),o=n.async.latch(1,function(){r(e.instances),i(e.instances,t),t.countDown()},"extensions");r(e.extensions,"extension"),i(e.extensions,o,!0),o.countDown()}},s=function(e){var t=n.async.latch(e.async?e.async.length:0,function(){a(n.config.context)},"dependencies");e.async.forEach(function(e){n.loader.loadScript(e,t.countDown)})},f=function(){if(!n.config.context||!n.config.context.dependencies)return a(n.config.context);var e;e=n.config.context.dependencies[n.config.mode]?n.config.context.dependencies[n.config.mode]:{sync:[],async:[]};var t=n.async.seqLatch(e.sync||[],function(e){n.loader.loadScript(e,t.next)},function(){s(e)});t.next()},u=function(e,t){for(var o=e.pop(),r=[];o;){if(n.object.get(window,o.namespace)){var i=n.object.get(window,o.namespace)();if(n.config=n.object.extend(n.config,i),i.imports){var c=n.array.extract(i.imports,"namespace");if(window.console.log("Arenite: Merging imports",c),n.array.contains(c,o.namespace))throw'You have declared a circular import for "'+o.namespace+'"';e=n.array.merge(e,i.imports)}}else r.push(o);o=e.pop()}if(0!==r.length){var a=n.async.latch(r.length,function(){u(r,t)},"imports");r.forEach(function(e){n.loader.loadScript(e.url,a.countDown)})}else t()},l=function(e,t){if(n.context.add("arenite",n),n.config=e,n.config.mode=n.url.query().env||"default",window.console.log("Arenite: Starting in mode",n.config.mode),e.expose){var o=e.expose;"function"==typeof e.expose&&(o=e.expose(n)),o&&(window[o]=n)}n.config.imports?(window.console.log("Arenite: Merging imports",n.array.extract(n.config.imports,"namespace")),u(JSON.parse(JSON.stringify(n.config.imports)),t)):t()},p=function(e){n.config?f():l(e,f)};return{di:{init:p,loadConfig:l,resolveArgs:t,exec:o}}},Arenite.Loader=function(arenite){var _loadResource=function(n,e,t){var o=new window.XMLHttpRequest;o.open("GET",n,!0),o.onreadystatechange=function(){4===o.readyState&&(o.status%100<4?e(o):"function"==typeof t&&t(o))},o.setRequestHeader("X-Requested-With","XMLHttpRequest"),o.setRequestHeader("Access-Control-Allow-Origin",window.location.origin),o.send()},_loadScriptWithTag=function(n,e){var t=document.getElementsByTagName("head")[0],o=document.createElement("script");o.async=!0,o.type="text/javascript",o.onreadystatechange=function(){"complete"===this.readyState&&e()},o.onload=e,o.src=n,t.appendChild(o)},_loadScriptAsResource=function(url,callback){_loadResource(url,function(req){arenite.annotation.processAnnotations(req.responseText);var file_tag="\n//@ sourceURL="+window.location.origin+"/"+url+"\n//# sourceURL="+window.location.origin+"/"+url;eval(req.responseText+file_tag),callback()})},_sameOrigin=function(n){var e=window.location,t=document.createElement("a");return t.href=n,t.hostname===e.hostname&&t.port===e.port&&t.protocol===e.protocol},_loadScriptFrom=function(n,e){_sameOrigin(n)?_loadScriptAsResource(n,e):_loadScriptWithTag(n,e)},_loadScript=function(n,e){"string"==typeof n?_loadScriptFrom(n,e):_loadScriptFrom(n.url,function(){arenite.object.keys(n.instances).forEach(function(e){arenite.context.add(e,window[n.instances[e]]),delete window[n.instances[e]]}),"function"==typeof e&&e()})};return{loader:{loadResource:_loadResource,loadScript:_loadScript}}},Arenite.Object=function(){var n=function(n,e){if(n){var t=e.split("."),o=t.splice(t.length-1,1),r=n;return t.forEach(function(n){r&&(r[n]||(r[n]={}),r=r[n])}),{object:r,path:o}}},e=function(n,e){if(n){var t=e.split("."),o=n;return t.forEach(function(n){o&&(o=o[n])}),o}},t=function(e,t,o){var r=n(e,t);return r&&r.object?(r.object[r.path]=o,r.object[r.path]):void 0},o=function(e,t){var o=n(e,t);o&&o.object&&delete o.object[o.path]},r=function(n,e){for(var t in e)e.hasOwnProperty(t)&&(n[t]&&"object"==typeof n[t]?n[t].constructor===Array&&e[t].constructor===Array?n[t]=a(n[t].concat(e[t])):r(n[t],e[t]):n[t]=e[t]);return n},i=function(n){var e,t=[];for(e in n)n.hasOwnProperty(e)&&t.push(e);return t},c=function(n,e){if(n.length){var t=!1;return n.forEach(function(n){t=t||n===e}),t}for(var o in n)if(n.hasOwnProperty(o)&&o===e)return!0;return!1},a=function(n){var e=[];return n.forEach(function(n){e.indexOf(n)<0&&e.push(n)}),e},s=function(n,e,t){var o=[];return n.forEach(function(n){o.push(n)}),e.forEach(function(n){o.push(n)}),t?o:a(o)},f=function(n,e){var t=[];for(var o in n)n.hasOwnProperty(o)&&t.push(n[o][e]);return t};return{object:{get:e,set:t,"delete":o,extend:r,keys:i,contains:c},array:{contains:c,uniq:a,merge:s,extract:f}}},Arenite.Url=function(){var n,e=function(e){if(!n||e){n={};for(var t=window.location.search.substring(1),o=t.split("&"),r=0;r<o.length;r++){var i=o[r].split("=");"undefined"==typeof n[i[0]]?n[i[0]]=i[1]:"string"==typeof n[i[0]]?n[i[0]]=[n[i[0]],i[1]]:n[i[0]].push(i[1])}}return n};return{url:{query:e}}};