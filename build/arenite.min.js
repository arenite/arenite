/*!
 * Arenite JavaScript Library v1.1.0
 * https://github.com/lcavadas/arenite
 *
 * Copyright 2014, LuÃ­s Serralheiro
 */
Arenite=function(n){var e=Arenite.Object(e);return e=e.object.extend(e,Arenite.Html(e)),e=e.object.extend(e,Arenite.Async(e)),e=e.object.extend(e,Arenite.Url(e)),e=e.object.extend(e,Arenite.DI(e)),e=e.object.extend(e,Arenite.AnnotationProcessor(e)),e=e.object.extend(e,Arenite.Context(e)),e=e.object.extend(e,Arenite.Loader(e)),e=e.object.extend(e,Arenite.Bus(e)),e.di.init(n),e},Arenite.AnnotationProcessor=function(arenite){var _processAnnotations=function(n){for(var e,t=/@arenite-instance\s+["']([^"']+)["']\s*(.*);\s*(@arenite-init\s+["']([^"']+)["']\s*(.*);)*\s*(@arenite-start\s+["']([^"']+)["']\s*(.*);)*\s*\*\/\s*([\w.]+)/g;e=t.exec(n);)_processAnnotation(e)},_processArgAnnotation=function(match){var args=[],split=match.split(",");return split.forEach(function(arg){var argPair=arg.split(":"),argObj={};argObj[argPair[0].trim()]="ref"===argPair[0].trim()?argPair[1].trim():eval(argPair[1].trim()),args.push(argObj)}),args},_processAnnotation=function(n){var e=n[1],t=n[9];if(arenite.config.context||(arenite.config.context={instances:{}}),arenite.config.context.instances[e]={namespace:t},n[2]&&(arenite.config.context.instances[e].args=_processArgAnnotation(n[2])),n[4]&&(arenite.config.context.instances[e].init={func:n[4]},n[5]&&(arenite.config.context.instances[e].init.args=_processArgAnnotation(n[5]))),n[7]){var o={instance:e,func:n[7]};n[8]&&(o.args=_processArgAnnotation(n[8])),arenite.config.context.start||(arenite.config.context.start=[]),arenite.config.context.start.push(o)}};return{annotation:{processAnnotations:_processAnnotations}}},Arenite.Async=function(n){var e=function(n,e,t){var o=0,i=n.length,r=function(){i>o?e(n[o++]):t()};return{next:r}},t=function(e,t,o){var i=0,r=o||(new Date).getTime();return n.config.debug&&(window.console.groupCollapsed('Latch: Starting latch "'+r+'" for',e,"times"),window.console.trace(),window.console.groupEnd()),{countDown:function(){i++,n.config.debug&&window.console.log('Latch: Counting down latch "'+r+'" ,',e-i,"remaining"),i===e&&(n.config.debug&&window.console.log('Latch: Triggering latch "'+r+'"'),t(i))},countUp:function(){i--,n.config.debug&&window.console.log('Latch: Counting up latch "'+r+'" ,',e-i,"remaining"),i===e&&(n.config.debug&&window.console.log('Latch: Triggering latch "'+r+'"'),t(i))}}};return{async:{seqLatch:function(n,t,o){return new e(n,t,o)},latch:function(n,e,o){return new t(n,e,o)}}}},Arenite.Bus=function(){var n={},e=function(e,t){n[e]||(n[e]=[]),n[e].push(t)},t=function(e,t){n[e]&&n[e].forEach(function(o,i){o===t&&n[e].splice(i,1)})},o=function(e,t){window.console.groupCollapsed('sending event:"'+e+'" with ',t),window.console.trace(),window.console.groupEnd(),n[e]&&n[e].forEach(function(n){window.setTimeout(function(){n(t)},0)})};return{bus:{subscribe:e,unsubscribe:t,publish:o}}},Arenite.Context=function(n){var e={},t={},o=1,i=function(n,o,i){i?t[n]=o:e[n]=o},r=function(t){n.object["delete"](e,t)},c=function(i){if(t.hasOwnProperty(i)){var c="__factory_instance_"+i+"__"+o++,a={};a[c]=n.object.extend(t[i],{factory:!1}),n.di.wire(a);var s=e[c];return r(c),s}return e[i]};return window.require=c,window.define=function(n,e,t){t||(t=e,e=n,n=void 0),Array.isArray(e)||(t=e,e=[]);var o=[];e.forEach(function(n){o.push(c(n))});var r=t.apply(window,o);if(!n)try{throw new Error}catch(a){var s=a.stack.trim().match(/([^\/]+?)(\.min)*\.js[:\d]+\)*$/m);s.length>1&&(n=s[1])}n&&i(n,r)},window.define.amd={jQuery:!0},{context:{get:c,add:i,remove:r}}},Arenite.DI=function(n){var e=1,t=function(e){var t=e.func;return t="function"==typeof e.func?e.func:e.extension?n.object.get(n[e.instance],e.func):n.object.get(n.context.get(e.instance),e.func)},o=function(t,o,i){if(!t.args)return[];var r=!1,c=[];return t.args.forEach(function(o,a){if("undefined"!=typeof o.value)c.push(o.value);else if("undefined"!=typeof o.ref){var u=n.context.get(o.ref);u?c.push(u):r=!0}else if("undefined"!=typeof o.func)c.push(o.func);else if("undefined"!=typeof o.exec)c.push(o.exec(n));else if("undefined"!=typeof o.instance){var f={instances:{}},d="__anonymous_temp_instance__"+e++;f.instances[d]=o.instance,s(f),c.push(n.context.get(d)),"factory"===i?n.context.remove(d):t.args.splice(a,1,{ref:d})}}),t.wait&&"function"==typeof o&&c.push(o),r?null:c},i=function(n,e,i){var r=t(n);if(!r)throw'Unknown function "'+n.func+'" for instance "'+n.instance+'"';var c=o(n,i);if(!c)throw'Unable to resolve arguments for "'+n.func+'" of instance "'+n.instance+'"';n.wait&&"function"==typeof e&&e(),r.apply(r,c)},r=function(e,t){if(e){var i=n.object.keys(e),c={};i.forEach(function(i){if(e[i].factory)n.context.add(i,e[i],!0);else{var r=n.object.get(window,e[i].namespace);if(!r)throw'Unknown function "'+e[i].namespace+'"';var a=o(e[i],null,t);if(a){var s=r.apply(r,a);if("extension"===t){var u={};u[i]=s,n=n.object.extend(n,u)}else n.context.add(i,s)}else c[i]=e[i]}});var a=n.object.keys(c);if(a.length!==n.object.keys(e).length&&a.length>0)r(c);else if(0!==a.length)throw"Make sure you don't have circular dependencies, Unable to resolve the following instances: "+a.join(", ")}},c=function(e,t,o){n.object.keys(e).forEach(function(r){e[r].init&&!e[r].factory&&("string"==typeof e[r].init&&(e[r].init={func:e[r].init}),i(n.object.extend({instance:r,extension:o},e[r].init),function(){t.countUp()},function(){t.countDown()}))})},a=function(n){n&&("complete"!==document.readyState?window.setTimeout(function(){a(n)},100):n.forEach(function(n){i(n)}))},s=function(e){if(n.config.debug&&window.console.time("Arenite context load"),e){var t=n.async.latch(1,function(){n.config.debug&&window.console.timeEnd("Arenite context load"),a(e.start)},"instances"),o=n.async.latch(1,function(){r(e.instances),c(e.instances,t),t.countDown()},"extensions");r(e.extensions,"extension"),c(e.extensions,o,!0),o.countDown()}},u=function(e){var t=n.async.latch(e.async?e.async.length:0,function(){s(n.config.context)},"dependencies");e.async.forEach(function(e){n.loader.loadScript(e,t.countDown)})},f=function(){if(!n.config.context||!n.config.context.dependencies)return s(n.config.context);var e;e=n.config.context.dependencies[n.config.mode]?n.config.context.dependencies[n.config.mode]:{sync:[],async:[]};var t=n.async.seqLatch(e.sync||[],function(e){n.loader.loadScript(e,t.next)},function(){u(e)});t.next()},d=/^((http:\/\/)|(http:\/\/)|(\/\/)).*$/,l=/[\d]+\.[\d]+\.*[\d]*/,p="https://rawgit.com/{vendor}/{version}/{module}/",g="https://cdn.rawgit.com/{vendor}/{version}/{module}/",h=function(e,t){var o=n.object.keys(e);if(o.length){var i=n.async.latch(o.length,t,"modules");n.object.forEach(e,function(e){var t,o=e.vendor?"default":n.config.mode;e.vendor?(t=n.config.repo?n.config.repo:e.version.match(l)?g.replace("{vendor}",e.vendor):p.replace("{vendor}",e.vendor),t=t.replace("{version}",e.version),t=t.replace("{module}",e.module)):t=e.module,n.loader.loadResource(t+"module.json",function(e){var r=JSON.parse(e.responseText),c={async:[],sync:[]};n.object.forEach(r.context.dependencies[o],function(e,o){e.forEach(function(e){"string"==typeof e?c[o].push(e.match(d)?e:t+e):c[o].push(n.object.extend(e,{url:e.url.match(d)?e.url:t+e.url}))})}),delete r.context.dependencies,n.config.context=n.config.context||{},n.config.context.dependencies=n.config.context.dependencies||{"default":{sync:[],async:[]}},n.config.context.dependencies[o]=n.config.context.dependencies[o]||{sync:[],async:[]},n.object.forEach(n.config.context.dependencies,function(e){n.object.extend(e,c)}),n.config=n.object.extend(n.config,r),r.imports&&r.imports?h(r.imports,i.countDown):i.countDown()})})}else t()},v=function(e,t){if(n.context.add("arenite",n),n.config=e,n.config.mode=n.config.mode||n.url.query().mode||"default",window.console.log("Arenite: Starting in mode",n.config.mode),e.debug&&"function"==typeof e.debug&&(e.debug=e.debug(n)),e.expose){var o=e.expose;"function"==typeof e.expose&&(o=e.expose(n)),o&&(window[o]=n)}n.config.imports?(window.console.log("Arenite: Fetching modules",n.object.keys(n.config.imports)),h(JSON.parse(JSON.stringify(n.config.imports)),t)):t()},w=function(e){n.config?f():v(e,f)},y=function(n){r(n,"factory"),c(n)};return{di:{init:w,loadConfig:v,resolveArgs:o,exec:i,wire:y}}},Arenite.Html=function(n){var e=function(n){var e=document.createElement("span");return e.innerText=n,e.innerHTML},t=function(n){var e=document.createElement("span");return e.innerHTML=n,e.innerText};return{html:{escape:e,unescape:t}}},Arenite.Loader=function(arenite){var firefoxOs=navigator.userAgent.indexOf("Firefox")>-1&&navigator.userAgent.indexOf("Mobile")>-1,_createCORSRequest=function(n,e,t,o){var i=new XMLHttpRequest;return i.open(n,e,!0),i.onreadystatechange=function(){4===i.readyState&&(i.status%100<4?t():o())},arenite.config.withCredentials&&("withCredentials"in i?i.withCredentials=!0:"undefined"!=typeof XDomainRequest?(i=new XDomainRequest,i.open(n,e),i.onload=t,i.onerror=o):i=null),i},_loadResource=function(n,e,t){var o=_createCORSRequest("GET",n,function(){e(o)},function(){"function"==typeof t&&t(o)});o.send()},_loadStyleWithTag=function(n,e){var t=document.getElementsByTagName("head")[0],o=document.createElement("link");o.rel="stylesheet",o.type="text/css",-1===navigator.appVersion.indexOf("MSIE 9")&&(o.onreadystatechange=function(){"complete"===this.readyState&&e()}),o.onload=e,o.href=n,t.appendChild(o)},_loadScriptWithTag=function(n,e){var t=document.getElementsByTagName("head")[0],o=document.createElement("script");o.async=!0,o.type="text/javascript",-1===navigator.appVersion.indexOf("MSIE 9")&&(o.onreadystatechange=function(){"complete"===this.readyState&&e()}),o.onload=e,o.src=n,t.appendChild(o)},_loadScriptAsResource=function(url,callback){_loadResource(url,function(req){arenite.annotation.processAnnotations(req.responseText);var file_tag="\n//@ sourceURL="+window.location.origin+"/"+url+"\n//# sourceURL="+window.location.origin+"/"+url;eval(req.responseText+file_tag),callback()})},_sameOrigin=function(n){var e=window.location,t=document.createElement("a");return t.href=n,t.hostname===e.hostname&&t.port===e.port&&t.protocol===e.protocol},_loadScriptFrom=function(n,e){var t=n.match(/.*\.(\w+)\?*.*/)[1];if(_sameOrigin(n)&&!firefoxOs&&"js"===t)_loadScriptAsResource(n,e);else if("js"===t)_loadScriptWithTag(n,e);else{if("css"!==t)throw'Uknown extension "'+t+'"';_loadStyleWithTag(n,e)}},_loadScript=function(n,e){"string"==typeof n?_loadScriptFrom(n,e):_loadScriptFrom(n.url,function(){arenite.object.keys(n.instances).forEach(function(e){arenite.context.add(e,window[n.instances[e]]),"function"==typeof n.init&&n.init(arenite),delete window[n.instances[e]]}),"function"==typeof e&&e()})};return{loader:{loadResource:_loadResource,loadScript:_loadScript}}},Arenite.Object=function(){var n=function(n,e){if(n){var t=e.split("."),o=t.splice(t.length-1,1),i=n;return t.forEach(function(n){i&&(i[n]||(i[n]={}),i=i[n])}),{object:i,path:o}}},e=function(n,e){if(n){var t=e.split("."),o=n;return t.forEach(function(n){o&&(o=o[n])}),o}},t=function(e,t,o){var i=n(e,t);return i&&i.object?(i.object[i.path]=o,i.object[i.path]):void 0},o=function(e,t){var o=n(e,t);o&&o.object&&delete o.object[o.path]},i=function(n,e){for(var t in e)e.hasOwnProperty(t)&&(n[t]&&"object"==typeof n[t]?n[t].constructor===Array&&e[t]&&e[t].constructor===Array?n[t]=a(n[t].concat(e[t])):i(n[t],e[t]):n[t]=e[t]);return n},r=function(n){var e,t=[];for(e in n)n.hasOwnProperty(e)&&t.push(e);return t},c=function(n,e){if(n.length){var t=!1;return n.forEach(function(n){t=t||n===e}),t}for(var o in n)if(n.hasOwnProperty(o)&&o===e)return!0;return!1},a=function(n){var e=[];return n.forEach(function(n){e.indexOf(n)<0&&e.push(n)}),e},s=function(n,e,t){var o=[];return n.forEach(function(n){o.push(n)}),e.forEach(function(n){o.push(n)}),t?o:a(o)},u=function(n,e){var t=[];for(var o in n)n.hasOwnProperty(o)&&t.push(n[o][e]);return t},f=function(n,t){var o={};return n.forEach(function(n){o[e(n,t)]=n}),o},d=function(n,e){var t;for(t in n)n.hasOwnProperty(t)&&e(n[t],t)},l=function(n){var e,t=[];for(e in n)n.hasOwnProperty(e)&&t.push(n[e]);return t},p=function(n){var e=[];return d(n,function(n){e.push(n)}),e},g=function(n,e){var t={};return e.forEach(function(e){n.hasOwnProperty(e)&&(t[e]=n[e])}),t};return{object:{get:e,set:t,"delete":o,extend:i,keys:r,forEach:d,values:l,contains:c,array:p,filter:g},array:{contains:c,uniq:a,merge:s,extract:u,obj:f}}},Arenite.Url=function(){var n,e=function(e){if(!n||e){n={};for(var t=window.location.search.substring(1),o=t.split("&"),i=0;i<o.length;i++){var r=o[i].split("=");"undefined"==typeof n[r[0]]?n[r[0]]=r[1]:"string"==typeof n[r[0]]?n[r[0]]=[n[r[0]],r[1]]:n[r[0]].push(r[1])}}return n};return{url:{query:e}}};