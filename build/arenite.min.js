/*!
 * Arenite JavaScript Library v2.0.0-rc1
 * https://github.com/lcavadas/arenite
 *
 * Copyright 2014, LuÃ­s Serralheiro
 */
Arenite=function(n){var e=Arenite.Object();return e.object.forEach(e.object,function(n,e){Object.prototype[e]||(Object.prototype[e]=function(){return n.apply(this,[this].concat([].slice.call(arguments)))})}),e.array.forEach(function(n,e){Array.prototype[e]||(Array.prototype[e]=function(){return n.apply(this,[this].concat([].slice.call(arguments)))})}),e.extend(Arenite.Html(e)),e.extend(Arenite.Async(e)),e.extend(Arenite.Url(e)),e.extend(Arenite.DI(e)),e.extend(Arenite.AnnotationProcessor(e)),e.extend(Arenite.Context(e)),e.extend(Arenite.Loader(e)),e.extend(Arenite.Bus(e)),e.di.init(n),e},Arenite.AnnotationProcessor=function(arenite){var _processAnnotations=function(n){for(var e,t=/@arenite-instance\s+["']([^"']+)["']\s*(.*);\s*(@arenite-init\s+["']([^"']+)["']\s*(.*);)*\s*(@arenite-start\s+["']([^"']+)["']\s*(.*);)*\s*\*\/\s*([\w.]+)/g;e=t.exec(n);)_processAnnotation(e)},_processArgAnnotation=function(match){var args=[],split=match.split(",");return split.forEach(function(arg){var argPair=arg.split(":"),argObj={};argObj[argPair[0].trim()]="ref"===argPair[0].trim()?argPair[1].trim():eval(argPair[1].trim()),args.push(argObj)}),args},_processAnnotation=function(n){var e=n[1],t=n[9];if(arenite.config.context||(arenite.config.context={instances:{}}),arenite.config.context.instances[e]={namespace:t},n[2]&&(arenite.config.context.instances[e].args=_processArgAnnotation(n[2])),n[4]&&(arenite.config.context.instances[e].init={func:n[4]},n[5]&&(arenite.config.context.instances[e].init.args=_processArgAnnotation(n[5]))),n[7]){var o={instance:e,func:n[7]};n[8]&&(o.args=_processArgAnnotation(n[8])),arenite.config.context.start||(arenite.config.context.start=[]),arenite.config.context.start.push(o)}};return{annotation:{processAnnotations:_processAnnotations}}},Arenite.Async=function(arenite){var _sequencialLatch=function(n,e,t){var o=0,r=n.length,i=function(){r>o?e(n[o],o++):t()};return{next:i}},_latch=function(n,e,t){var o=0,r=t||(new Date).getTime();return arenite.config.debug&&(window.console.groupCollapsed('Latch: Starting latch "'+r+'" for',n,"times"),window.console.trace(),window.console.groupEnd()),{countDown:function(){o++,arenite.config.debug&&window.console.log('Latch: Counting down latch "'+r+'" ,',n-o,"remaining"),o===n&&(arenite.config.debug&&window.console.log('Latch: Triggering latch "'+r+'"'),e(o))},countUp:function(){o--,arenite.config.debug&&window.console.log('Latch: Counting up latch "'+r+'" ,',n-o,"remaining"),o===n&&(arenite.config.debug&&window.console.log('Latch: Triggering latch "'+r+'"'),e(o))}}},_webworker=function(){var self=this;self.arenite={},self.onmessage=function(e){e.data.arenite.forEach(function(dep){arenite=eval("("+dep.code+")();")}),e.data.deps.forEach(function(dep){"raw"===dep.type?self.set(dep.name,eval("(function(){ return "+dep.code+";})();")):self.set(dep.name,eval("("+dep.code+")();"))});var result=self.__MAIN__.apply(this,e.data.args);self.postMessage(result)}},_serialize=function(n,e){var t=n.toString();return e&&(t=t.slice(t.indexOf("{")+1,t.lastIndexOf("}"))),t},_createWebWorker=function(n,e,t,o){var r=t,i=new Worker(URL.createObjectURL(new Blob([_serialize(_webworker,!0)])));i.onmessage=function(n){r(n.data),o||i.terminate()};var c=[];(e||[]).forEach(function(n){c.push({name:n.name,code:_serialize(n.func),type:n.type})}),c.push({name:"__MAIN__",code:_serialize(n),type:"raw"});var a={exec:function(n,e){return e&&(r=e),i.postMessage({args:n,deps:c,arenite:[{name:"object",code:_serialize(Arenite.Object)}]}),a},kill:function(){o&&i.terminate()}};return a};return{async:{seqLatch:_sequencialLatch,latch:_latch,webworker:_createWebWorker}}},Arenite.Bus=function(){var n={},e=function(e,t){n[e]||(n[e]=[]),n[e].push(t)},t=function(e,t){n[e]&&n[e].forEach(function(o,r){o===t&&n[e].splice(r,1)})},o=function(e,t){window.console.groupCollapsed('sending event:"'+e+'" with ',t),window.console.trace(),window.console.groupEnd(),n[e]&&n[e].forEach(function(n){window.setTimeout(function(){n(t)},0)})};return{bus:{subscribe:e,unsubscribe:t,publish:o}}},Arenite.Context=function(n){var e={},t={},o=1,r=function(n,o,r){r?t[n]=o:e[n]=o},i=function(n){e["delete"](n)},c=function(r){if(t.hasOwnProperty(r)){var c="__factory_instance_"+r+"__"+o++,a={};a[c]=t[r].extend({factory:!1}),n.di.wire(a);var s=e[c];return i(c),s}return e[r]};return window.require=c,window.define=function(n,e,t){for(;!Array.isArray(e);)t=e,e="function"==typeof n||Array.isArray(n)?n:[],n="string"==typeof n?n:void 0;var o=[];e.forEach(function(n){o.push(c(n))});var i=t.apply(window,o);if(!n)try{throw new Error}catch(a){var s=/([^\/]+?)(\.min)*\.js[:\d]+\)*$/gm;if(s.exec(a.stack)){var f=s.exec(a.stack);f.length>1&&(n=f[1])}}n&&r(n,i)},window.define.amd={jQuery:!0},{context:{get:c,add:r,remove:i}}},Arenite.DI=function(n){var e=1,t=function(e){var t=e.func;return t="function"==typeof e.func?e.func:e.extension?n[e.instance].get(e.func):n.context.get(e.instance).get(e.func)},o=function(t,o,r,i){t.args=t.args||[];var c=!1,a=[];return t.args.forEach(function(o,f){if("undefined"!=typeof o.value)a.push(o.value);else if("undefined"!=typeof o.ref){var u=n.context.get(o.ref);u?a.push(u):(c=!0,n.debug&&window.console.log("Arenite: Failed to resolve arg",o))}else if("undefined"!=typeof o.func)a.push(o.func);else if("undefined"!=typeof o.exec)a.push(o.exec(n));else if("undefined"!=typeof o.instance){var d={instances:{}},l="__anonymous_temp_instance__"+e++;d.instances[l]=o.instance,s(d,i),a.push(n.context.get(l)),"factory"===r?n.context.remove(l):t.args.splice(f,1,{ref:l})}}),t.wait&&"function"==typeof o&&a.push(o),c?null:a},r=function(n,e,r,i){var c=t(n);if(!c)throw'Unknown function "'+n.func+'" for instance "'+n.instance+'"';var a=o(n,r,void 0,i);if(!a)throw'Unable to resolve arguments for "'+n.func+'" of instance "'+n.instance+'"';n.wait&&"function"==typeof e&&e(),c.apply(c,a)},i=function(e,t,r){if(e){var c={};if(e.keys().forEach(function(r){if(e[r].factory)n.context.add(r,e[r],!0);else{var i=window.get(e[r].namespace);if(!i)throw'Unknown function "'+e[r].namespace+'"';var a=o(e[r],null,t,[r]);if(a){var s=i.apply(i,a);if("extension"===t){var f={};f[r]=s,n=n.extend(f)}n.debug&&window.console.log("Arenite: Instance",r,"wired"),n.context.add(r,s)}else c[r]=e[r]}}),c.keys().length!==e.keys().length&&c.keys().length>0)c.forEach(function(n,e){var t={};t[e]=n,i(t,void 0,r.concat(e))});else if(0!==c.keys().length)throw"Make sure you don't have circular dependencies, Unable to resolve the following instances: "+c.keys().join(", ")+" - ["+r.join(", ")+"]"}},c=function(n,e,t){n&&n.forEach(function(n,o){n.init&&!n.factory&&("string"==typeof n.init&&(n.init={func:n.init}),r({instance:o,extension:t}.extend(n.init),function(){e.countUp()},function(){e.countDown()}))})},a=function(n){n&&("complete"!==document.readyState?window.setTimeout(function(){a(n)},100):n.forEach(function(n){r(n)}))},s=function(e,t){if(n.config.debug&&window.console.time("Arenite context load"),e){var o=n.async.latch(1,function(){n.config.debug&&window.console.timeEnd("Arenite context load"),a(e.start)},"instances"),r=n.async.latch(1,function(){i(e.instances,void 0,t||[]),c(e.instances,o),o.countDown()},"extensions");i(e.extensions,"extension",t||[]),c(e.extensions,r,!0),r.countDown()}},f=function(e){var t=n.async.latch(e.async?e.async.length:0,function(){s(n.config.context)},"dependencies");e.async.forEach(function(e){n.loader.loadScript(e,t.countDown)})},u=function(){if(!n.config.context||!n.config.context.dependencies)return s(n.config.context);var e;e=n.config.context.dependencies[n.config.mode]?n.config.context.dependencies[n.config.mode]:{sync:[],async:[]};var t=n.async.seqLatch(e.sync||[],function(e){n.loader.loadScript(e,t.next)},function(){f(e)});t.next()},d=/^((http:\/\/)|(http:\/\/)|(\/\/)).*$/,l=/[\d]+\.[\d]+\.*[\d]*/,p="//rawgit.com/{vendor}/{version}/{module}/",g="//cdn.rawgit.com/{vendor}/{version}/{module}/",h=function(e,t){if(e.keys().length){var o=n.async.latch(e.keys().length,t,"modules");e.forEach(function(e){var t,r=e.vendor?e.mode?e.mode:"default":n.config.mode;e.vendor?(t=n.config.repo?n.config.repo.replace("{vendor}",e.vendor):e.version.match(l)?g.replace("{vendor}",e.vendor):p.replace("{vendor}",e.vendor),t=t.replace("{version}",e.version),t=t.replace("{module}",e.module)):t=e.module+"/",n.loader.loadResource(t+"module.json",function(i){var c=JSON.parse(i.responseText),a={async:[],sync:[]};c.context.dependencies[r].forEach(function(n,o){n.forEach(function(n){"string"==typeof n?a[o].push(n.match(d)||!e.vendor?n:t+n):a[o].push(n.extend({url:n.url.match(d)||!e.vendor?n.url:t+n.url}))})}),delete c.context.dependencies,n.config.context=n.config.context||{},n.config.context.dependencies=n.config.context.dependencies||{"default":{sync:[],async:[]}},n.config.context.dependencies[n.config.mode]=n.config.context.dependencies[n.config.mode]||{sync:[],async:[]},n.config.context.dependencies.forEach(function(n){n.extend(a)}),n.config=n.config.extend(c),c.imports&&c.imports?h(c.imports,o.countDown):o.countDown()})})}else t()},v=function(e,t){if(n.context.add("arenite",n),n.config=e,n.config.mode=n.config.mode||n.url.query().mode||"default",window.console.log("Arenite: Starting in mode",n.config.mode),e.debug&&"function"==typeof e.debug&&(e.debug=e.debug(n)),e.expose){var o=e.expose;"function"==typeof e.expose&&(o=e.expose(n)),o&&(window[o]=n)}n.config.imports?(window.console.log("Arenite: Fetching modules",n.config.imports.keys()),h(JSON.parse(JSON.stringify(n.config.imports)),t)):t()},w=function(e){n.config?u():v(e,u)},y=function(n){i(n,"factory",[]),c(n)};return{di:{init:w,loadConfig:v,resolveArgs:o,exec:r,wire:y}}},Arenite.Html=function(n){var e=function(n){var e=document.createElement("span");return e.innerText=n,e.innerHTML},t=function(n){var e=document.createElement("span");return e.innerHTML=n,e.innerText};return{html:{escape:e,unescape:t}}},Arenite.Loader=function(arenite){var firefoxOs=navigator.userAgent.indexOf("Firefox")>-1&&navigator.userAgent.indexOf("Mobile")>-1,_createCORSRequest=function(n,e,t,o){var r=new XMLHttpRequest;return r.open(n,e,!0),r.onreadystatechange=function(){4===r.readyState&&(r.status%100<4?t():o())},arenite.config.withCredentials&&("withCredentials"in r?r.withCredentials=!0:"undefined"!=typeof XDomainRequest?(r=new XDomainRequest,r.open(n,e),r.onload=t,r.onerror=o):r=null),r},_loadResource=function(n,e,t){var o=_createCORSRequest("GET",n,function(){e(o)},function(){"function"==typeof t&&t(o)});o.send()},_loadStyleWithTag=function(n,e){var t=document.getElementsByTagName("head")[0],o=document.createElement("link");o.rel="stylesheet",o.type="text/css",-1===navigator.appVersion.indexOf("MSIE 9")&&(o.onreadystatechange=function(){"complete"===this.readyState&&e()}),o.onload=e,o.href=n,t.appendChild(o)},_loadScriptWithTag=function(n,e){var t=document.getElementsByTagName("head")[0],o=document.createElement("script");o.async=!0,o.type="text/javascript",-1===navigator.appVersion.indexOf("MSIE 9")&&(o.onreadystatechange=function(){"complete"===this.readyState&&e()}),o.onload=e,o.src=n,t.appendChild(o)},_loadScriptAsResource=function(url,callback){_loadResource(url,function(req){arenite.annotation.processAnnotations(req.responseText);var file_tag="\n//@ sourceURL="+window.location.origin+"/"+url+"\n//# sourceURL="+window.location.origin+"/"+url;eval(req.responseText+file_tag),callback()})},_sameOrigin=function(n){var e=window.location,t=document.createElement("a");return t.href=n,t.hostname===e.hostname&&t.port===e.port&&t.protocol===e.protocol},_loadScriptFrom=function(n,e){var t=n.match(/.*\.(\w+)\?*.*/)[1];if(_sameOrigin(n)&&!firefoxOs&&"js"===t)_loadScriptAsResource(n,e);else if("js"===t)_loadScriptWithTag(n,e);else{if("css"!==t)throw'Uknown extension "'+t+'"';_loadStyleWithTag(n,e)}},_loadScript=function(n,e){"string"==typeof n?_loadScriptFrom(n,e):_loadScriptFrom(n.url,function(){n.instances.forEach(function(e,t){arenite.context.add(t,window[e]),"function"==typeof n.init&&n.init(arenite),delete window[e]}),"function"==typeof e&&e()})};return{loader:{loadResource:_loadResource,loadScript:_loadScript}}},Arenite.Object=function(){var n=function(n,e){if(n){var t=e.split("."),o=t.splice(t.length-1,1),r=n;return t.forEach(function(n){r&&(r[n]||(r[n]={}),r=r[n])}),{object:r,path:o}}},e=function(n,e){if(n){var t=e.split("."),o=n;return t.forEach(function(n){o&&(o=o[n])}),o}},t=function(e,t,o){var r=n(e,t);return r&&r.object?(r.object[r.path]=o,r.object[r.path]):void 0},o=function(e,t){var o=n(e,t);o&&o.object&&delete o.object[o.path]},r=function(n,e){for(var t in e)e.hasOwnProperty(t)&&(n[t]&&"object"==typeof n[t]?n[t].constructor===Array&&e[t]&&e[t].constructor===Array?n[t]=a(n[t].concat(e[t])):r(n[t],e[t]):n[t]=e[t]);return n},i=function(n){var e,t=[];for(e in n)n.hasOwnProperty(e)&&t.push(e);return t},c=function(n,e){if(n.length){var t=!1;return n.forEach(function(n){t=t||n===e}),t}for(var o in n)if(n.hasOwnProperty(o)&&o===e)return!0;return!1},a=function(n){var e=[];return n.forEach(function(n){e.indexOf(n)<0&&e.push(n)}),e},s=function(n,e,t){var o=[];return n.forEach(function(n){o.push(n)}),e.forEach(function(n){o.push(n)}),t?o:a(o)},f=function(n,e){var t=[];for(var o in n)n.hasOwnProperty(o)&&t.push(n[o][e]);return t},u=function(n,t){var o={};return n.forEach(function(n){o[e(n,t)]=n}),o},d=function(n,e){var t;for(t in n)n.hasOwnProperty(t)&&e(n[t],t)},l=function(n){var e,t=[];for(e in n)n.hasOwnProperty(e)&&t.push(n[e]);return t},p=function(n){var e=[];return d(n,function(n){e.push(n)}),e},g=function(n,e){var t={};return e.forEach(function(e){n.hasOwnProperty(e)&&(t[e]=n[e])}),t};return{object:{get:e,set:t,"delete":o,extend:r,keys:i,forEach:d,values:l,contains:c,array:p,filter:g},array:{contains:c,uniq:a,merge:s,extract:f,obj:u}}},Arenite.Url=function(){var n,e=function(e){if(!n||e){n={};for(var t=window.location.search.substring(1),o=t.split("&"),r=0;r<o.length;r++){var i=o[r].split("=");"undefined"==typeof n[i[0]]?n[i[0]]=i[1]:"string"==typeof n[i[0]]?n[i[0]]=[n[i[0]],i[1]]:n[i[0]].push(i[1])}}return n};return{url:{query:e}}};