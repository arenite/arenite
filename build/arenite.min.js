/*!
 * Arenite JavaScript Library v1.1.0
 * https://github.com/lcavadas/arenite
 *
 * Copyright 2014, LuÃ­s Serralheiro
 */
Arenite=function(e){var n=Arenite.Object(n);return n=n.object.extend(n,Arenite.Html(n)),n=n.object.extend(n,Arenite.Async(n)),n=n.object.extend(n,Arenite.Url(n)),n=n.object.extend(n,Arenite.DI(n)),n=n.object.extend(n,Arenite.AnnotationProcessor(n)),n=n.object.extend(n,Arenite.Context(n)),n=n.object.extend(n,Arenite.Loader(n)),n=n.object.extend(n,Arenite.Bus(n)),n.di.init(e),n},Arenite.AnnotationProcessor=function(arenite){var _processAnnotations=function(e){for(var n,t=/@arenite-instance\s+["']([^"']+)["']\s*(.*);\s*(@arenite-init\s+["']([^"']+)["']\s*(.*);)*\s*(@arenite-start\s+["']([^"']+)["']\s*(.*);)*\s*\*\/\s*([\w.]+)/g;n=t.exec(e);)_processAnnotation(n)},_processArgAnnotation=function(match){var args=[],split=match.split(",");return split.forEach(function(arg){var argPair=arg.split(":"),argObj={};argObj[argPair[0].trim()]="ref"===argPair[0].trim()?argPair[1].trim():eval(argPair[1].trim()),args.push(argObj)}),args},_processAnnotation=function(e){var n=e[1],t=e[9];if(arenite.config.context||(arenite.config.context={instances:{}}),arenite.config.context.instances[n]={namespace:t},e[2]&&(arenite.config.context.instances[n].args=_processArgAnnotation(e[2])),e[4]&&(arenite.config.context.instances[n].init={func:e[4]},e[5]&&(arenite.config.context.instances[n].init.args=_processArgAnnotation(e[5]))),e[7]){var o={instance:n,func:e[7]};e[8]&&(o.args=_processArgAnnotation(e[8])),arenite.config.context.start||(arenite.config.context.start=[]),arenite.config.context.start.push(o)}};return{annotation:{processAnnotations:_processAnnotations}}},Arenite.Async=function(arenite){var _sequencialLatch=function(e,n,t){var o=0,r=e.length,i=function(){r>o?n(e[o++]):t()};return{next:i}},_latch=function(e,n,t){var o=0,r=t||(new Date).getTime();return arenite.config.debug&&(window.console.groupCollapsed('Latch: Starting latch "'+r+'" for',e,"times"),window.console.trace(),window.console.groupEnd()),{countDown:function(){o++,arenite.config.debug&&window.console.log('Latch: Counting down latch "'+r+'" ,',e-o,"remaining"),o===e&&(arenite.config.debug&&window.console.log('Latch: Triggering latch "'+r+'"'),n(o))},countUp:function(){o--,arenite.config.debug&&window.console.log('Latch: Counting up latch "'+r+'" ,',e-o,"remaining"),o===e&&(arenite.config.debug&&window.console.log('Latch: Triggering latch "'+r+'"'),n(o))}}},_webworker=function(){var self=this,window=self;self.arenite={},self.onmessage=function(e){e.data.arenite.forEach(function(dep){arenite=eval("("+dep.code+")();")}),e.data.deps.forEach(function(dep){"raw"===dep.type?arenite.object.set(self,dep.name,eval("(function(){ return "+dep.code+";})();")):arenite.object.set(self,dep.name,eval("("+dep.code+")();"))});var result=self.__MAIN__.apply(this,e.data.args);self.postMessage(result)}},_serialize=function(e,n){var t=e.toString();return n&&(t=t.slice(t.indexOf("{")+1,t.lastIndexOf("}"))),t},_createWebWorker=function(e,n,t,o){var r=t,i=new Worker(URL.createObjectURL(new Blob([_serialize(_webworker,!0)])));i.onmessage=function(e){r(e.data),o||i.terminate()};var c=[];(n||[]).forEach(function(e){c.push({name:e.name,code:_serialize(e.func),type:e.type})}),c.push({name:"__MAIN__",code:_serialize(e),type:"raw"});var a={exec:function(e,n){return n&&(r=n),i.postMessage({args:e,deps:c,arenite:[{name:"object",code:_serialize(Arenite.Object)}]}),a},kill:function(){o&&i.terminate()}};return a};return{async:{seqLatch:_sequencialLatch,latch:_latch,webworker:_createWebWorker}}},Arenite.Bus=function(){var e={},n=function(n,t){e[n]||(e[n]=[]),e[n].push(t)},t=function(n,t){e[n]&&e[n].forEach(function(o,r){o===t&&e[n].splice(r,1)})},o=function(n,t){window.console.groupCollapsed('sending event:"'+n+'" with ',t),window.console.trace(),window.console.groupEnd(),e[n]&&e[n].forEach(function(e){window.setTimeout(function(){e(t)},0)})};return{bus:{subscribe:n,unsubscribe:t,publish:o}}},Arenite.Context=function(e){var n={},t={},o=1,r=function(e,o,r){r?t[e]=o:n[e]=o},i=function(t){e.object["delete"](n,t)},c=function(r){if(t.hasOwnProperty(r)){var c="__factory_instance_"+r+"__"+o++,a={};a[c]=e.object.extend(t[r],{factory:!1}),e.di.wire(a);var s=n[c];return i(c),s}return n[r]};return window.require=c,window.define=function(e,n,t){for(;!Array.isArray(n);)t=n,n="function"==typeof e||Array.isArray(e)?e:[],e="string"==typeof e?e:void 0;var o=[];n.forEach(function(e){o.push(c(e))});var i=t.apply(window,o);if(!e)try{throw new Error}catch(a){var s=/([^\/]+?)(\.min)*\.js[:\d]+\)*$/gm;if(s.exec(a.stack)){var f=s.exec(a.stack);f.length>1&&(e=f[1])}}e&&r(e,i)},window.define.amd={jQuery:!0},{context:{get:c,add:r,remove:i}}},Arenite.DI=function(e){var n=1,t=function(n){var t=n.func;return t="function"==typeof n.func?n.func:n.extension?e.object.get(e[n.instance],n.func):e.object.get(e.context.get(n.instance),n.func)},o=function(t,o,r,i){t.args=t.args||[];var c=!1,a=[];return t.args.forEach(function(o,f){if("undefined"!=typeof o.value)a.push(o.value);else if("undefined"!=typeof o.ref){var u=e.context.get(o.ref);u?a.push(u):(c=!0,e.debug&&window.console.log("Arenite: Failed to resolve arg",o))}else if("undefined"!=typeof o.func)a.push(o.func);else if("undefined"!=typeof o.exec)a.push(o.exec(e));else if("undefined"!=typeof o.instance){var d={instances:{}},l="__anonymous_temp_instance__"+n++;d.instances[l]=o.instance,s(d,i),a.push(e.context.get(l)),"factory"===r?e.context.remove(l):t.args.splice(f,1,{ref:l})}}),t.wait&&"function"==typeof o&&a.push(o),c?null:a},r=function(e,n,r,i){var c=t(e);if(!c)throw'Unknown function "'+e.func+'" for instance "'+e.instance+'"';var a=o(e,r,void 0,i);if(!a)throw'Unable to resolve arguments for "'+e.func+'" of instance "'+e.instance+'"';e.wait&&"function"==typeof n&&n(),c.apply(c,a)},i=function(n,t,r){if(n){var c=e.object.keys(n),a={};c.forEach(function(r){if(n[r].factory)e.context.add(r,n[r],!0);else{var i=e.object.get(window,n[r].namespace);if(!i)throw'Unknown function "'+n[r].namespace+'"';var c=o(n[r],null,t,[r]);if(c){var s=i.apply(i,c);if("extension"===t){var f={};f[r]=s,e=e.object.extend(e,f)}e.debug&&window.console.log("Arenite: Instance",r,"wired"),e.context.add(r,s)}else a[r]=n[r]}});var s=e.object.keys(a);if(s.length!==e.object.keys(n).length&&s.length>0)e.object.forEach(a,function(e,n){var t={};t[n]=e,i(t,void 0,r.concat(n))});else if(0!==s.length)throw"Make sure you don't have circular dependencies, Unable to resolve the following instances: "+s.join(", ")+" - ["+r.join(", ")+"]"}},c=function(n,t,o){e.object.keys(n).forEach(function(i){n[i].init&&!n[i].factory&&("string"==typeof n[i].init&&(n[i].init={func:n[i].init}),r(e.object.extend({instance:i,extension:o},n[i].init),function(){t.countUp()},function(){t.countDown()}))})},a=function(e){e&&("complete"!==document.readyState?window.setTimeout(function(){a(e)},100):e.forEach(function(e){r(e)}))},s=function(n,t){if(e.config.debug&&window.console.time("Arenite context load"),n){var o=e.async.latch(1,function(){e.config.debug&&window.console.timeEnd("Arenite context load"),a(n.start)},"instances"),r=e.async.latch(1,function(){i(n.instances,void 0,t||[]),c(n.instances,o),o.countDown()},"extensions");i(n.extensions,"extension",t||[]),c(n.extensions,r,!0),r.countDown()}},f=function(n){var t=e.async.latch(n.async?n.async.length:0,function(){s(e.config.context)},"dependencies");n.async.forEach(function(n){e.loader.loadScript(n,t.countDown)})},u=function(){if(!e.config.context||!e.config.context.dependencies)return s(e.config.context);var n;n=e.config.context.dependencies[e.config.mode]?e.config.context.dependencies[e.config.mode]:{sync:[],async:[]};var t=e.async.seqLatch(n.sync||[],function(n){e.loader.loadScript(n,t.next)},function(){f(n)});t.next()},d=/^((http:\/\/)|(http:\/\/)|(\/\/)).*$/,l=/[\d]+\.[\d]+\.*[\d]*/,p="//rawgit.com/{vendor}/{version}/{module}/",g="//cdn.rawgit.com/{vendor}/{version}/{module}/",h=function(n,t){var o=e.object.keys(n);if(o.length){var r=e.async.latch(o.length,t,"modules");e.object.forEach(n,function(n){var t,o=n.vendor?"default":e.config.mode;n.vendor?(t=e.config.repo?e.config.repo.replace("{vendor}",n.vendor):n.version.match(l)?g.replace("{vendor}",n.vendor):p.replace("{vendor}",n.vendor),t=t.replace("{version}",n.version),t=t.replace("{module}",n.module)):t=n.module+"/",e.loader.loadResource(t+"module.json",function(i){var c=JSON.parse(i.responseText),a={async:[],sync:[]};e.object.forEach(c.context.dependencies[o],function(o,r){o.forEach(function(o){"string"==typeof o?a[r].push(o.match(d)||!n.vendor?o:t+o):a[r].push(e.object.extend(o,{url:o.url.match(d)||!n.vendor?o.url:t+o.url}))})}),delete c.context.dependencies,e.config.context=e.config.context||{},e.config.context.dependencies=e.config.context.dependencies||{"default":{sync:[],async:[]}},e.config.context.dependencies[e.config.mode]=e.config.context.dependencies[e.config.mode]||{sync:[],async:[]},e.object.forEach(e.config.context.dependencies,function(n){e.object.extend(n,a)}),e.config=e.object.extend(e.config,c),c.imports&&c.imports?h(c.imports,r.countDown):r.countDown()})})}else t()},v=function(n,t){if(e.context.add("arenite",e),e.config=n,e.config.mode=e.config.mode||e.url.query().mode||"default",window.console.log("Arenite: Starting in mode",e.config.mode),n.debug&&"function"==typeof n.debug&&(n.debug=n.debug(e)),n.expose){var o=n.expose;"function"==typeof n.expose&&(o=n.expose(e)),o&&(window[o]=e)}e.config.imports?(window.console.log("Arenite: Fetching modules",e.object.keys(e.config.imports)),h(JSON.parse(JSON.stringify(e.config.imports)),t)):t()},w=function(n){e.config?u():v(n,u)},y=function(e){i(e,"factory",[]),c(e)};return{di:{init:w,loadConfig:v,resolveArgs:o,exec:r,wire:y}}},Arenite.Html=function(e){var n=function(e){var n=document.createElement("span");return n.innerText=e,n.innerHTML},t=function(e){var n=document.createElement("span");return n.innerHTML=e,n.innerText};return{html:{escape:n,unescape:t}}},Arenite.Loader=function(arenite){var firefoxOs=navigator.userAgent.indexOf("Firefox")>-1&&navigator.userAgent.indexOf("Mobile")>-1,_createCORSRequest=function(e,n,t,o){var r=new XMLHttpRequest;return r.open(e,n,!0),r.onreadystatechange=function(){4===r.readyState&&(r.status%100<4?t():o())},arenite.config.withCredentials&&("withCredentials"in r?r.withCredentials=!0:"undefined"!=typeof XDomainRequest?(r=new XDomainRequest,r.open(e,n),r.onload=t,r.onerror=o):r=null),r},_loadResource=function(e,n,t){var o=_createCORSRequest("GET",e,function(){n(o)},function(){"function"==typeof t&&t(o)});o.send()},_loadStyleWithTag=function(e,n){var t=document.getElementsByTagName("head")[0],o=document.createElement("link");o.rel="stylesheet",o.type="text/css",-1===navigator.appVersion.indexOf("MSIE 9")&&(o.onreadystatechange=function(){"complete"===this.readyState&&n()}),o.onload=n,o.href=e,t.appendChild(o)},_loadScriptWithTag=function(e,n){var t=document.getElementsByTagName("head")[0],o=document.createElement("script");o.async=!0,o.type="text/javascript",-1===navigator.appVersion.indexOf("MSIE 9")&&(o.onreadystatechange=function(){"complete"===this.readyState&&n()}),o.onload=n,o.src=e,t.appendChild(o)},_loadScriptAsResource=function(url,callback){_loadResource(url,function(req){arenite.annotation.processAnnotations(req.responseText);var file_tag="\n//@ sourceURL="+window.location.origin+"/"+url+"\n//# sourceURL="+window.location.origin+"/"+url;eval(req.responseText+file_tag),callback()})},_sameOrigin=function(e){var n=window.location,t=document.createElement("a");return t.href=e,t.hostname===n.hostname&&t.port===n.port&&t.protocol===n.protocol},_loadScriptFrom=function(e,n){var t=e.match(/.*\.(\w+)\?*.*/)[1];if(_sameOrigin(e)&&!firefoxOs&&"js"===t)_loadScriptAsResource(e,n);else if("js"===t)_loadScriptWithTag(e,n);else{if("css"!==t)throw'Uknown extension "'+t+'"';_loadStyleWithTag(e,n)}},_loadScript=function(e,n){"string"==typeof e?_loadScriptFrom(e,n):_loadScriptFrom(e.url,function(){arenite.object.keys(e.instances).forEach(function(n){arenite.context.add(n,window[e.instances[n]]),"function"==typeof e.init&&e.init(arenite),delete window[e.instances[n]]}),"function"==typeof n&&n()})};return{loader:{loadResource:_loadResource,loadScript:_loadScript}}},Arenite.Object=function(){var e=function(e,n){if(e){var t=n.split("."),o=t.splice(t.length-1,1),r=e;return t.forEach(function(e){r&&(r[e]||(r[e]={}),r=r[e])}),{object:r,path:o}}},n=function(e,n){if(e){var t=n.split("."),o=e;return t.forEach(function(e){o&&(o=o[e])}),o}},t=function(n,t,o){var r=e(n,t);return r&&r.object?(r.object[r.path]=o,r.object[r.path]):void 0},o=function(n,t){var o=e(n,t);o&&o.object&&delete o.object[o.path]},r=function(e,n){for(var t in n)n.hasOwnProperty(t)&&(e[t]&&"object"==typeof e[t]?e[t].constructor===Array&&n[t]&&n[t].constructor===Array?e[t]=a(e[t].concat(n[t])):r(e[t],n[t]):e[t]=n[t]);return e},i=function(e){var n,t=[];for(n in e)e.hasOwnProperty(n)&&t.push(n);return t},c=function(e,n){if(e.length){var t=!1;return e.forEach(function(e){t=t||e===n}),t}for(var o in e)if(e.hasOwnProperty(o)&&o===n)return!0;return!1},a=function(e){var n=[];return e.forEach(function(e){n.indexOf(e)<0&&n.push(e)}),n},s=function(e,n,t){var o=[];return e.forEach(function(e){o.push(e)}),n.forEach(function(e){o.push(e)}),t?o:a(o)},f=function(e,n){var t=[];for(var o in e)e.hasOwnProperty(o)&&t.push(e[o][n]);return t},u=function(e,t){var o={};return e.forEach(function(e){o[n(e,t)]=e}),o},d=function(e,n){var t;for(t in e)e.hasOwnProperty(t)&&n(e[t],t)},l=function(e){var n,t=[];for(n in e)e.hasOwnProperty(n)&&t.push(e[n]);return t},p=function(e){var n=[];return d(e,function(e){n.push(e)}),n},g=function(e,n){var t={};return n.forEach(function(n){e.hasOwnProperty(n)&&(t[n]=e[n])}),t};return{object:{get:n,set:t,"delete":o,extend:r,keys:i,forEach:d,values:l,contains:c,array:p,filter:g},array:{contains:c,uniq:a,merge:s,extract:f,obj:u}}},Arenite.Url=function(){var e,n=function(n){if(!e||n){e={};for(var t=window.location.search.substring(1),o=t.split("&"),r=0;r<o.length;r++){var i=o[r].split("=");"undefined"==typeof e[i[0]]?e[i[0]]=i[1]:"string"==typeof e[i[0]]?e[i[0]]=[e[i[0]],i[1]]:e[i[0]].push(i[1])}}return e};return{url:{query:n}}};