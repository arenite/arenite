/*!
 * Arenite JavaScript Library v0.0.2
 * https://github.com/lcavadas/arenite
 *
 * Copyright 2014, LuÃ­s Serralheiro
 */
Arenite=function(n){var e=new Arenite.Object(e);e=e.object.extend(e,new Arenite.Async),e=e.object.extend(e,new Arenite.Url),e=e.object.extend(e,new Arenite.DI(e)),e=e.object.extend(e,new Arenite.Loader(e)),e.di.loadConfig(n)},Arenite.Async=function(){var n=function(n,e,t){var o=0,i=n.length,r=function(){i>o?e(n[o++]):t()};return{next:r}},e=function(n,e,t){var o=t||(new Date).getTime();window.console.groupCollapsed('Latch: Starting latch "'+o+'" for',n,"times"),window.console.trace(),window.console.groupEnd();var i=0;return{countDown:function(){i++,window.console.log('Latch: Counting down latch "'+o+'" ,',n-i,"remaining"),i===n&&(window.console.log('Latch: Triggering latch "'+o+'"'),e(i))},countUp:function(){i--,window.console.log('Latch: Counting up latch "'+o+'" ,',n-i,"remaining"),i===n&&(window.console.log('Latch: Triggering latch "'+o+'"'),e(i))}}};return{async:{seqLatch:function(e,t,o){return new n(e,t,o)},latch:function(n,t,o){return new e(n,t,o)}}}},Arenite.DI=function(arenite){var registry={},factories={},_resolveFunc=function(n){var e=n.func;return e="function"==typeof n.func?n.func:n.extension?arenite.object.get(arenite[n.instance],n.func):arenite.object.get(_getInstance(n.instance),n.func)},_resolveArgs=function(n,e){if(!n.args)return[];var t=!1,o=[];return n.args.forEach(function(n){if("undefined"!=typeof n.value)o.push(n.value);else if("undefined"!=typeof n.ref){var e=_getInstance(n.ref);e?o.push(e):t=!0}else"undefined"!=typeof n.func?o.push(n.func):"undefined"!=typeof n.exec?o.push(n.exec(arenite)):"undefined"!=typeof n.instance&&o.push(_wire([n.instance],"anonymous"))}),n.wait&&"function"==typeof e&&o.push(e),t?null:o},_execFunction=function(n,e,t){var o=_resolveFunc(n);if(!o)throw'Unknown function "'+n.func+'" for instance "'+n.instance+'"';var i=_resolveArgs(n,t);if(!i)throw'Unable to resolve arguments for "'+n.func+'" of instance "'+n.instance+'"';n.wait&&"function"==typeof e&&e(),o.apply(o,i)},_addInstance=function(n,e,t,o){registry[n]=e,t&&(factories[n]=o||[])},_getInstance=function(n){if(factories.hasOwnProperty(n)){var e=_resolveArgs({args:factories[n]});if(e)return registry[n].apply(registry[n],e);throw'Unable to resolve arguments for "'+n+'"'}return registry[n]},_wire=function(n,e){if(n){var t=arenite.object.keys(n),o={},i=[];t.forEach(function(t){var r=arenite.object.get(window,n[t].namespace);if(!r)throw'Unknown function "'+n[t].namespace+'"';var a=_resolveArgs(n[t]);if(a){window.console.log("Arenite:",t,"wired");var c=n[t].factory?r:r.apply(r,a);if("extension"===e){var s={};s[t]=c,arenite=arenite.object.extend(arenite,s)}else"anonymous"===e?i.push(c):_addInstance(t,c,n[t].factory,n[t].args||[])}else o[t]=n[t]});var r=arenite.object.keys(o);if(r.length!==arenite.object.keys(n).length&&r.length>0)arenite.array.merge(i,_wire(o));else if(0!==r.length)throw"Make sure you don't have circular dependencies, Unable to resolve the following instances: "+r.join(", ");return i}},_init=function(n,e,t){arenite.object.keys(n).forEach(function(o){n[o].init&&("string"==typeof n[o].init&&(n[o].init={func:n[o].init}),_execFunction(arenite.object.extend({instance:o,extension:t},n[o].init),function(){e.countUp()},function(){window.console.log("Arenite:",o,"initialized"),e.countDown()}))})},_start=function(n){n&&("complete"!==document.readyState?window.setTimeout(function(){_start(n)},100):n.forEach(function(n){_execFunction(n)}))},_loadContext=function(){if(arenite.config.context){var n=arenite.async.latch(1,function(){window.console.log("Arenite: start instances"),_start(arenite.config.context.start)},"instances"),e=arenite.async.latch(1,function(){window.console.log("Arenite: wire instances"),_wire(arenite.config.context.instances),window.console.log("Arenite: init instances"),_init(arenite.config.context.instances,n),n.countDown()},"extensions");window.console.log("Arenite: wire extensions"),_wire(arenite.config.context.extensions,"extension"),window.console.log("Arenite: init extensions"),_init(arenite.config.context.extensions,e,!0),e.countDown()}},_loadAsyncDependencies=function(n){var e=arenite.async.latch(n.async?n.async.length:0,_loadContext,"dependencies");n.async.forEach(function(n){arenite.loader.loadScript(n,e.countDown)})},_loadSyncDependencies=function(){if(!arenite.config.context||!arenite.config.context.dependencies)return _loadContext();var n;n=arenite.config.context.dependencies[arenite.config.mode]?arenite.config.context.dependencies[arenite.config.mode]:{sync:[],async:[]};var e=arenite.async.seqLatch(n.sync||[],function(n){arenite.loader.loadScript(n,e.next)},function(){_loadAsyncDependencies(n)});e.next()},_mergeImports=function(n){for(var e=n.pop(),t=[];e;)arenite.object.get(window,e.namespace)?arenite.config=arenite.object.extend(arenite.config,arenite.object.get(window,e.namespace)()):t.push(e),e=n.pop();if(0!==t.length){var o=arenite.async.latch(t.length,function(){_mergeImports(t)},"imports");t.forEach(function(n){arenite.loader.loadScript(n.url,o.countDown)})}else _loadSyncDependencies()},_loadConfig=function(n){_addInstance("arenite",arenite),arenite.config=n,arenite.config.mode=arenite.url.query().env||"default",window.console.log("Arenite: Starting in mode",arenite.config.mode),n.expose&&(window.arenite=arenite),arenite.config.imports?_mergeImports(JSON.parse(JSON.stringify(arenite.config.imports))):_loadSyncDependencies()},_processAnnotations=function(n){for(var e,t=/@arenite-instance\s+["']([^"']+)["']\s*(.*);\s*(@arenite-init\s+["']([^"']+)["']\s*(.*);)*\s*(@arenite-start\s+["']([^"']+)["']\s*(.*);)*\s*\*\/\s*([\w.]+)/g;e=t.exec(n);)_processAnnotation(e)},_processArgAnnotation=function(match){var args=[],split=match.split(",");return split.forEach(function(arg){var argPair=arg.split(":"),argObj={};argObj[argPair[0].trim()]="ref"===argPair[0].trim()?argPair[1].trim():eval(argPair[1].trim()),args.push(argObj)}),args},_processAnnotation=function(n){var e=n[1],t=n[9];if(e&&(arenite.config.context||(arenite.config.context={instances:{}}),arenite.config.context.instances[e]={namespace:t},n[2]&&(arenite.config.context.instances[e].args=_processArgAnnotation(n[2])),n[4]&&(arenite.config.context.instances[e].init={func:n[4]},n[5]&&(arenite.config.context.instances[e].init.args=_processArgAnnotation(n[5]))),n[7])){var o={instance:e,func:n[7]};n[8]&&(o.args=_processArgAnnotation(n[8])),arenite.config.context.start||(arenite.config.context.start=[]),arenite.config.context.start.push(o)}};return{di:{loadConfig:_loadConfig,getInstance:_getInstance,addInstance:_addInstance,processAnnotations:_processAnnotations}}},Arenite.Loader=function(arenite){var _loadResource=function(n,e,t){var o=new window.XMLHttpRequest;o.open("GET",n,!0),o.onreadystatechange=function(){4===o.readyState&&(o.status%100<4?e(o):"function"==typeof t&&t(o))},o.setRequestHeader("X-Requested-With","XMLHttpRequest"),o.setRequestHeader("Access-Control-Allow-Origin",window.location.origin),o.send()},_loadScriptWithTag=function(n,e){var t=document.getElementsByTagName("head")[0],o=document.createElement("script");o.async=!0,o.type="text/javascript",o.onreadystatechange=function(){"complete"===this.readyState&&e()},o.onload=e,o.src=n,t.appendChild(o)},_loadScriptAsResource=function(url,callback){_loadResource(url,function(req){arenite.di.processAnnotations(req.responseText);var file_tag="\n//@ sourceURL="+window.location.origin+"/"+url+"\n//# sourceURL="+window.location.origin+"/"+url;eval(req.responseText+file_tag),callback()})},_sameOrigin=function(n){var e=window.location,t=document.createElement("a");return t.href=n,t.hostname===e.hostname&&t.port===e.port&&t.protocol===e.protocol},_loadScript=function(n,e){_sameOrigin(n)?_loadScriptAsResource(n,e):_loadScriptWithTag(n,e)};return{loader:{loadResource:_loadResource,loadScript:_loadScript}}},Arenite.Object=function(){var n=function(n,e){if(n){var t=e.split("."),o=t.splice(t.length-1,1),i=n;return t.forEach(function(n){i&&(i[n]||(i[n]={}),i=i[n])}),{object:i,path:o}}},e=function(n,e){if(n){var t=e.split("."),o=n;return t.forEach(function(n){o&&(o=o[n])}),o}},t=function(e,t,o){var i=n(e,t);return i&&i.object?(i.object[i.path]=o,i.object[i.path]):void 0},o=function(e,t){var o=n(e,t);o&&o.object&&delete o.object[o.path]},i=function(n,e){for(var t in e)e.hasOwnProperty(t)&&(n[t]&&"object"==typeof n[t]?n[t].constructor===Array&&e[t].constructor===Array?n[t]=c(n[t].concat(e[t])):i(n[t],e[t]):n[t]=e[t]);return n},r=function(n){var e,t=[];for(e in n)n.hasOwnProperty(e)&&t.push(e);return t},a=function(n,e){if(n.length){var t=!1;return n.forEach(function(n){t=t||n===e}),t}for(var o in n)if(n.hasOwnProperty(o)&&o===e)return!0;return!1},c=function(n){var e=[];return n.forEach(function(n){e.indexOf(n)<0&&e.push(n)}),e},s=function(n,e){var t=[];return n.forEach(function(n){t.push(n)}),e.forEach(function(n){t.push(n)}),c(t)};return{object:{get:e,set:t,"delete":o,extend:i,keys:r,contains:a},array:{contains:a,uniq:c,merge:s}}},Arenite.Url=function(){var n,e=function(e){if(!n||e){n={};var t=window.location.search.substring(1),o=t.split("#")[0];o=o.split("&");for(var i=0;i<o.length;i++){var r=o[i].split("=");"undefined"==typeof n[r[0]]?n[r[0]]=r[1]:"string"==typeof n[r[0]]?n[r[0]]=[n[r[0]],r[1]]:n[r[0]].push(r[1])}}return n};return{url:{query:e}}};