IOC=function(n){var o=new IOC.Object(o);o=o.object.extend(o,new IOC.Async),o=o.object.extend(o,new IOC.Url),o=o.object.extend(o,new IOC.DI(o)),o=o.object.extend(o,new IOC.Loader(o)),o.di.loadConfig(n)},IOC.Async=function(){var n=function(n,o,e){var t=0,c=n.length,i=function(){c>t?o(n[t++]):e()};return{next:i}},o=function(n,o,e){var t=e||(new Date).getTime();window.console.groupCollapsed('Latch: Starting latch "'+t+'" for',n,"times"),window.console.trace(),window.console.groupEnd();var c=0;return{countDown:function(){c++,window.console.log('Latch: Counting down latch "'+t+'" ,',n-c,"remaining"),c===n&&(window.console.log('Latch: Triggering latch "'+t+'"'),o(c))},countUp:function(){c--,window.console.log('Latch: Counting up latch "'+t+'" ,',n-c,"remaining"),c===n&&(window.console.log('Latch: Triggering latch "'+t+'"'),o(c))}}};return{async:{seqLatch:function(o,e,t){return new n(o,e,t)},latch:function(n,e,t){return new o(n,e,t)}}}},IOC.DI=function(ioc){var registry={},factories={},_resolveArgs=function(n){var o=!1,e=[];return n.forEach(function(n){if("undefined"!=typeof n.value)e.push(n.value);else if("undefined"!=typeof n.ref){var t=_getInstance(n.ref);t?e.push(t):o=!0}else"undefined"!=typeof n.func?e.push(n.func):"undefined"!=typeof n.exec&&e.push(n.exec())}),o?null:e},_execFunction=function(n,o,e){var t="function"==typeof o?o:ioc.object.get(_getInstance(n),o);if(!t)throw'Unknown function "'+o+'" for instance "'+n+'"';var c=_resolveArgs(e||[]);if(!c)throw'Unable to resolve arguments for "'+o+'" of instance "'+n+'"';t.apply(t,c)},_addInstance=function(n,o,e,t){registry[n]=o,e&&(factories[n]=t||[])},_getInstance=function(n){if(factories.hasOwnProperty(n)){var o=_resolveArgs(factories[n]||[]);if(o)return registry[n].apply(registry[n],o);throw'Unable to resolve arguments for "'+n+'"'}return registry[n]},_wire=function(n){if(n){var o=ioc.object.keys(n),e={};o.forEach(function(o){var t=ioc.object.get(window,n[o].namespace);if(!t)throw'Unknown function "'+n[o].namespace+'"';var c=_resolveArgs(n[o].args||[]);if(c){window.console.log(o,"wired");var i=n[o].factory?t:t.apply(t,c);_addInstance(o,i,n[o].factory,n[o].args||[]),n[o].extension&&(ioc=ioc.object.extend(ioc,i))}else e[o]=n[o]});var t=ioc.object.keys(e);if(t.length!==ioc.object.keys(n).length&&t.length>0)_wire(e);else if(0!==t.length)throw"Make sure you don't have circular dependencies, Unable to resolve the following instances: "+t.join(", ")}},_init=function(n){ioc.object.keys(n).forEach(function(o){n[o].init&&_execFunction(o,n[o].init.func,n[o].init.args)})},_start=function(n){n&&("complete"!==document.readyState?window.setTimeout(function(){_start(n)},100):n.forEach(function(n){n.instance?_execFunction(n.instance,n.func,n.args):n.func&&_execFunction(null,n.func,n.args)}))},_loadContext=function(){ioc.config.context&&(window.console.log("wire instances"),_wire(ioc.config.context.instances),window.console.log("init instances"),_init(ioc.config.context.instances),window.console.log("start instances"),_start(ioc.config.context.start))},_loadAsyncDependencies=function(n){var o=ioc.async.latch(n.async?n.async.length:0,_loadContext,"dependencies");n.async.forEach(function(n){ioc.loader.loadScript(n,o.countDown)})},_loadSyncDependencies=function(){if(!ioc.config.context||!ioc.config.context.dependencies)return _loadContext();var n;n=ioc.config.context.dependencies[ioc.config.mode]?ioc.config.context.dependencies[ioc.config.mode]:{sync:[],async:[]};var o=ioc.async.seqLatch(n.sync||[],function(n){ioc.loader.loadScript(n,o.next)},function(){_loadAsyncDependencies(n)});o.next()},_mergeImports=function(n){for(var o=n.pop(),e=[];o;)ioc.object.get(window,o.namespace)?ioc.config=ioc.object.extend(ioc.config,ioc.object.get(window,o.namespace)()):e.push(o),o=n.pop();if(0!==e.length){var t=ioc.async.latch(e.length,function(){_mergeImports(e)},"imports");e.forEach(function(n){ioc.loader.loadScript(n.url,t.countDown)})}else _loadSyncDependencies()},_loadConfig=function(n){_addInstance("ioc",ioc),ioc.config=n,ioc.config.mode=ioc.url.query().env||"default",window.console.log("IOC: Starting in mode",ioc.config.mode),n.exposeIoc&&(window.ioc=ioc),ioc.config.imports?_mergeImports(JSON.parse(JSON.stringify(ioc.config.imports))):_loadSyncDependencies()},_processAnnotations=function(n){for(var o,e=/@ioc-instance\s+["']([^"']+)["']\s*(.*);\s*(@ioc-init\s+["']([^"']+)["']\s*(.*);)*\s*(@ioc-start\s+["']([^"']+)["']\s*(.*);)*\s*\*\/\s*([\w.]+)/g;o=e.exec(n);)_processAnnotation(o)},_processArgAnnotation=function(match){var args=[],split=match.split(",");return split.forEach(function(arg){var argPair=arg.split(":"),argObj={};argObj[argPair[0].trim()]="ref"===argPair[0].trim()?argPair[1].trim():eval(argPair[1].trim()),args.push(argObj)}),args},_processAnnotation=function(n){var o=n[1],e=n[9];if(o&&(ioc.config.context||(ioc.config.context={instances:{}}),ioc.config.context.instances[o]={namespace:e},n[2]&&(ioc.config.context.instances[o].args=_processArgAnnotation(n[2])),n[4]&&(ioc.config.context.instances[o].init={func:n[4]},n[5]&&(ioc.config.context.instances[o].init.args=_processArgAnnotation(n[5]))),n[7])){var t={instance:o,func:n[7]};n[8]&&(t.args=_processArgAnnotation(n[8])),ioc.config.context.start||(ioc.config.context.start=[]),ioc.config.context.start.push(t)}};return{di:{loadConfig:_loadConfig,getInstance:_getInstance,addInstance:_addInstance,processAnnotations:_processAnnotations}}},IOC.Loader=function(ioc){var _loadResource=function(n,o,e){var t=new window.XMLHttpRequest;t.open("GET",n),t.onreadystatechange=function(){4===t.readyState&&(t.status%100<4?o(t):"function"==typeof e&&e(t))},t.send()},_loadScript=function(url,callback){_loadResource(url,function(req){ioc.di.processAnnotations(req.responseText);var file_tag="\n//@ sourceURL="+window.location.origin+"/"+url+"\n//# sourceURL="+window.location.origin+"/"+url;eval(req.responseText+file_tag),callback()})};return{loader:{loadResource:_loadResource,loadScript:_loadScript}}},IOC.Object=function(){var n=function(n,o){if(n){var e=o.split("."),t=e.splice(e.length-1,1),c=n;return e.forEach(function(n){c&&(c[n]||(c[n]={}),c=c[n])}),{object:c,path:t}}},o=function(n,o){if(n){var e=o.split("."),t=n;return e.forEach(function(n){t&&(t=t[n])}),t}},e=function(o,e,t){var c=n(o,e);return c&&c.object?(c.object[c.path]=t,c.object[c.path]):void 0},t=function(o,e){var t=n(o,e);t&&t.object&&delete t.object[t.path]},c=function(n,o){for(var e in o)o.hasOwnProperty(e)&&(n[e]&&"object"==typeof n[e]?n[e].constructor===Array&&o[e].constructor===Array?n[e]=a(n[e].concat(o[e])):c(n[e],o[e]):n[e]=o[e]);return n},i=function(n){var o,e=[];for(o in n)n.hasOwnProperty(o)&&e.push(o);return e},r=function(n,o){if(n.length){var e=!1;return n.forEach(function(n){e=e||n===o}),e}for(var t in n)if(n.hasOwnProperty(t)&&t===o)return!0;return!1},a=function(n){var o=[];return n.forEach(function(n){o.indexOf(n)<0&&o.push(n)}),o};return{object:{get:o,set:e,"delete":t,extend:c,keys:i,contains:r},array:{contains:r,uniq:a}}},IOC.Url=function(){return{url:{query:function(){var n={},o=window.location.search.substring(1),e=o.split("#")[0];e=e.split("&");for(var t=0;t<e.length;t++){var c=e[t].split("=");"undefined"==typeof n[c[0]]?n[c[0]]=c[1]:"string"==typeof n[c[0]]?n[c[0]]=[n[c[0]],c[1]]:n[c[0]].push(c[1])}return n}}}};