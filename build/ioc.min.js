/*!
 * JIOC JavaScript Library v0.0.2
 * https://github.com/lcavadas/jioc
 *
 * Copyright 2014, LuÃ­s Serralheiro
 */
IOC=function(n){var o=new IOC.Object(o);o=o.object.extend(o,new IOC.Async),o=o.object.extend(o,new IOC.Url),o=o.object.extend(o,new IOC.DI(o)),o=o.object.extend(o,new IOC.Loader(o)),o.di.loadConfig(n)},IOC.Async=function(){var n=function(n,o,e){var t=0,c=n.length,i=function(){c>t?o(n[t++]):e()};return{next:i}},o=function(n,o,e){var t=e||(new Date).getTime();window.console.groupCollapsed('Latch: Starting latch "'+t+'" for',n,"times"),window.console.trace(),window.console.groupEnd();var c=0;return{countDown:function(){c++,window.console.log('Latch: Counting down latch "'+t+'" ,',n-c,"remaining"),c===n&&(window.console.log('Latch: Triggering latch "'+t+'"'),o(c))},countUp:function(){c--,window.console.log('Latch: Counting up latch "'+t+'" ,',n-c,"remaining"),c===n&&(window.console.log('Latch: Triggering latch "'+t+'"'),o(c))}}};return{async:{seqLatch:function(o,e,t){return new n(o,e,t)},latch:function(n,e,t){return new o(n,e,t)}}}},IOC.DI=function(ioc){var registry={},factories={},_resolveArgs=function(n){var o=!1,e=[];return n.forEach(function(n){if("undefined"!=typeof n.value)e.push(n.value);else if("undefined"!=typeof n.ref){var t=_getInstance(n.ref);t?e.push(t):o=!0}else"undefined"!=typeof n.func?e.push(n.func):"undefined"!=typeof n.exec&&e.push(n.exec(ioc))}),o?null:e},_execFunction=function(n,o,e,t){var c;if(c="function"==typeof o?o:t?ioc.object.get(ioc[n],o):ioc.object.get(_getInstance(n),o),!c)throw'Unknown function "'+o+'" for instance "'+n+'"';var i=_resolveArgs(e||[]);if(!i)throw'Unable to resolve arguments for "'+o+'" of instance "'+n+'"';c.apply(c,i)},_addInstance=function(n,o,e,t){registry[n]=o,e&&(factories[n]=t||[])},_getInstance=function(n){if(factories.hasOwnProperty(n)){var o=_resolveArgs(factories[n]||[]);if(o)return registry[n].apply(registry[n],o);throw'Unable to resolve arguments for "'+n+'"'}return registry[n]},_wire=function(n,o){if(n){var e=ioc.object.keys(n),t={};e.forEach(function(e){var c=ioc.object.get(window,n[e].namespace);if(!c)throw'Unknown function "'+n[e].namespace+'"';var i=_resolveArgs(n[e].args||[]);if(i){window.console.log(e,"wired");var r=n[e].factory?c:c.apply(c,i);if(o){var a={};a[e]=r,ioc=ioc.object.extend(ioc,a)}else _addInstance(e,r,n[e].factory,n[e].args||[])}else t[e]=n[e]});var c=ioc.object.keys(t);if(c.length!==ioc.object.keys(n).length&&c.length>0)_wire(t);else if(0!==c.length)throw"Make sure you don't have circular dependencies, Unable to resolve the following instances: "+c.join(", ")}},_init=function(n,o){ioc.object.keys(n).forEach(function(e){n[e].init&&_execFunction(e,n[e].init.func,n[e].init.args,o)})},_start=function(n){n&&("complete"!==document.readyState?window.setTimeout(function(){_start(n)},100):n.forEach(function(n){_execFunction(n.instance,n.func,n.args)}))},_loadContext=function(){ioc.config.context&&(window.console.log("wire extensions"),_wire(ioc.config.context.extensions,!0),window.console.log("init extensions"),_init(ioc.config.context.extensions,!0),window.console.log("wire instances"),_wire(ioc.config.context.instances),window.console.log("init instances"),_init(ioc.config.context.instances),window.console.log("start instances"),_start(ioc.config.context.start))},_loadAsyncDependencies=function(n){var o=ioc.async.latch(n.async?n.async.length:0,_loadContext,"dependencies");n.async.forEach(function(n){ioc.loader.loadScript(n,o.countDown)})},_loadSyncDependencies=function(){if(!ioc.config.context||!ioc.config.context.dependencies)return _loadContext();var n;n=ioc.config.context.dependencies[ioc.config.mode]?ioc.config.context.dependencies[ioc.config.mode]:{sync:[],async:[]};var o=ioc.async.seqLatch(n.sync||[],function(n){ioc.loader.loadScript(n,o.next)},function(){_loadAsyncDependencies(n)});o.next()},_mergeImports=function(n){for(var o=n.pop(),e=[];o;)ioc.object.get(window,o.namespace)?ioc.config=ioc.object.extend(ioc.config,ioc.object.get(window,o.namespace)()):e.push(o),o=n.pop();if(0!==e.length){var t=ioc.async.latch(e.length,function(){_mergeImports(e)},"imports");e.forEach(function(n){ioc.loader.loadScript(n.url,t.countDown)})}else _loadSyncDependencies()},_loadConfig=function(n){_addInstance("ioc",ioc),ioc.config=n,ioc.config.mode=ioc.url.query().env||"default",window.console.log("IOC: Starting in mode",ioc.config.mode),n.exposeIoc&&(window.ioc=ioc),ioc.config.imports?_mergeImports(JSON.parse(JSON.stringify(ioc.config.imports))):_loadSyncDependencies()},_processAnnotations=function(n){for(var o,e=/@ioc-instance\s+["']([^"']+)["']\s*(.*);\s*(@ioc-init\s+["']([^"']+)["']\s*(.*);)*\s*(@ioc-start\s+["']([^"']+)["']\s*(.*);)*\s*\*\/\s*([\w.]+)/g;o=e.exec(n);)_processAnnotation(o)},_processArgAnnotation=function(match){var args=[],split=match.split(",");return split.forEach(function(arg){var argPair=arg.split(":"),argObj={};argObj[argPair[0].trim()]="ref"===argPair[0].trim()?argPair[1].trim():eval(argPair[1].trim()),args.push(argObj)}),args},_processAnnotation=function(n){var o=n[1],e=n[9];if(o&&(ioc.config.context||(ioc.config.context={instances:{}}),ioc.config.context.instances[o]={namespace:e},n[2]&&(ioc.config.context.instances[o].args=_processArgAnnotation(n[2])),n[4]&&(ioc.config.context.instances[o].init={func:n[4]},n[5]&&(ioc.config.context.instances[o].init.args=_processArgAnnotation(n[5]))),n[7])){var t={instance:o,func:n[7]};n[8]&&(t.args=_processArgAnnotation(n[8])),ioc.config.context.start||(ioc.config.context.start=[]),ioc.config.context.start.push(t)}};return{di:{loadConfig:_loadConfig,getInstance:_getInstance,addInstance:_addInstance,processAnnotations:_processAnnotations}}},IOC.Loader=function(ioc){var _loadResource=function(n,o,e){var t=new window.XMLHttpRequest;t.open("GET",n,!0),t.onreadystatechange=function(){4===t.readyState&&(t.status%100<4?o(t):"function"==typeof e&&e(t))},t.setRequestHeader("X-Requested-With","XMLHttpRequest"),t.setRequestHeader("Access-Control-Allow-Origin",window.location.origin),t.send()},_loadScriptWithTag=function(n,o){var e=document.getElementsByTagName("head")[0],t=document.createElement("script");t.async=!0,t.type="text/javascript",t.onreadystatechange=function(){"complete"===this.readyState&&o()},t.onload=o,t.src=n,e.appendChild(t)},_loadScriptAsResource=function(url,callback){_loadResource(url,function(req){ioc.di.processAnnotations(req.responseText);var file_tag="\n//@ sourceURL="+window.location.origin+"/"+url+"\n//# sourceURL="+window.location.origin+"/"+url;eval(req.responseText+file_tag),callback()})},_sameOrigin=function(n){var o=window.location,e=document.createElement("a");return e.href=n,e.hostname===o.hostname&&e.port===o.port&&e.protocol===o.protocol},_loadScript=function(n,o){_sameOrigin(n)?_loadScriptAsResource(n,o):_loadScriptWithTag(n,o)};return{loader:{loadResource:_loadResource,loadScript:_loadScript}}},IOC.Object=function(){var n=function(n,o){if(n){var e=o.split("."),t=e.splice(e.length-1,1),c=n;return e.forEach(function(n){c&&(c[n]||(c[n]={}),c=c[n])}),{object:c,path:t}}},o=function(n,o){if(n){var e=o.split("."),t=n;return e.forEach(function(n){t&&(t=t[n])}),t}},e=function(o,e,t){var c=n(o,e);return c&&c.object?(c.object[c.path]=t,c.object[c.path]):void 0},t=function(o,e){var t=n(o,e);t&&t.object&&delete t.object[t.path]},c=function(n,o){for(var e in o)o.hasOwnProperty(e)&&(n[e]&&"object"==typeof n[e]?n[e].constructor===Array&&o[e].constructor===Array?n[e]=a(n[e].concat(o[e])):c(n[e],o[e]):n[e]=o[e]);return n},i=function(n){var o,e=[];for(o in n)n.hasOwnProperty(o)&&e.push(o);return e},r=function(n,o){if(n.length){var e=!1;return n.forEach(function(n){e=e||n===o}),e}for(var t in n)if(n.hasOwnProperty(t)&&t===o)return!0;return!1},a=function(n){var o=[];return n.forEach(function(n){o.indexOf(n)<0&&o.push(n)}),o};return{object:{get:o,set:e,"delete":t,extend:c,keys:i,contains:r},array:{contains:r,uniq:a}}},IOC.Url=function(){var n,o=function(o){if(!n||o){n={};var e=window.location.search.substring(1),t=e.split("#")[0];t=t.split("&");for(var c=0;c<t.length;c++){var i=t[c].split("=");"undefined"==typeof n[i[0]]?n[i[0]]=i[1]:"string"==typeof n[i[0]]?n[i[0]]=[n[i[0]],i[1]]:n[i[0]].push(i[1])}}return n};return{url:{query:o}}};