var IOC=function(n){var t={},e=function(n,t){var e=document.getElementsByTagName("head")[0],o=document.createElement("script");o.type="text/javascript",o.src=n,o.onreadystatechange=o.onload=function(){window.console.log("IOC: Loaded",n),"function"==typeof t&&t()},window.console.log("IOC: Loading",n),e.appendChild(o)},o=function(n,t,e){var o=new window.XMLHttpRequest;o.open("GET",n),o.onreadystatechange=function(){4===o.readyState&&(o.status%100<4?t(o):"function"==typeof e&&e(o))},o.send()},c=function(){t=new IOC.Object(t),t=t.object.extend(t,{loadScript:e,loadResource:o}),t=t.object.extend(t,new IOC.Async(t)),t=t.object.extend(t,new IOC.Url(t)),t=t.object.extend(t,new IOC.DI(t))},i=function(){c(),t.di.loadConfig(n)};i()};IOC.Url=function(){return{url:{query:function(){for(var n={},t=window.location.search.substring(1),e=t.split("&"),o=0;o<e.length;o++){var c=e[o].split("=");"undefined"==typeof n[c[0]]?n[c[0]]=c[1]:"string"==typeof n[c[0]]?n[c[0]]=[n[c[0]],c[1]]:n[c[0]].push(c[1])}return n}}}},IOC.Object=function(){var n=function(n,t){if(n){var e=t.split("."),o=e.splice(e.length-1,1),c=n;return e.forEach(function(n){c&&(c[n]||(c[n]={}),c=c[n])}),{object:c,path:o}}},t=function(n,t){if(n){var e=t.split("."),o=n;return e.forEach(function(n){o&&(o=o[n])}),o}},e=function(t,e,o){var c=n(t,e);return c.object?(c.object[c.path]=o,c.object[c.path]):void 0},o=function(t,e){var o=n(t,e);o&&delete o.object[o.path]},c=function(n,t){for(var e in t)t.hasOwnProperty(e)&&(n[e]&&"object"==typeof n[e]?n[e].constructor===Array&&t[e].constructor===Array?n[e]=a(n[e].concat(t[e])):c(n[e],t[e]):n[e]=t[e]);return n},i=function(n){var t,e=[];for(t in n)n.hasOwnProperty(t)&&e.push(t);return e},r=function(n,t){if(n.length){var e=!1;return n.forEach(function(n){e=e||n===t}),e}for(var o in n)if(n.hasOwnProperty(o)&&o===t)return!0;return!1},a=function(n){var t=[];return n.forEach(function(n){t.indexOf(n)<0&&t.push(n)}),t};return{object:{get:t,set:e,"delete":o,extend:c,keys:i},array:{contains:r,uniq:a}}},IOC.Async=function(){var n=function(n,t,e){var o=0,c=n.length,i=function(){c>o?t(n[o++]):e()};return{next:i}},t=function(n,t,e){var o=e||(new Date).getTime();window.console.log("Latch: Starting latch",o,"for",n,"times");var c=0;return{countDown:function(){c++,window.console.log("Latch: Counting down latch",o,",",n-c,"remaining"),c===n&&(window.console.log("Latch: Triggering latch",o),t(c))},countUp:function(){c--,window.console.log("Latch: Counting up latch",o,",",n-c,"remaining"),c===n-1&&(window.console.log("Latch: Triggering latch",o),t(c))}}};return{async:{seqLatch:function(t,e,o){return n(t,e,o)},latch:function(n,e,o){return new t(n,e,o)}}}},IOC.DI=function(n){var t={},e={},o=function(t){var e=!1,o=[];return t.forEach(function(t){if("undefined"!=typeof t.value)o.push(t.value);else if("undefined"!=typeof t.ref){var c=n.di.getInstance(t.ref);c?o.push(c):e=!0}else"undefined"!=typeof t.func?o.push(t.func):"undefined"!=typeof t.exec&&o.push(t.exec())}),e?null:o},c=function(t,e,c){var i="function"==typeof e?e:n.object.get(n.di.getInstance(t),e);if(!i)throw'Unknown function "'+e+'" for instance "'+t+'"';var r=o(c||[]);if(!r)throw'Unable to resolve arguments for "'+e+'" of instance "'+t+'"';i.apply(i,r)},i=function(n,o,c,i){t[n]=o,c&&(e[n]=i)},r=function(n){if(e.hasOwnProperty(n)){var c=o(e[n]);if(c)return t[n].apply(t[n],c);throw'Unable to resolve arguments for "'+n}return t[n]},a=function(t){if(!t)throw"Your context defines no instances";var e=n.object.keys(t),c={};e.forEach(function(e){var i=n.object.get(window,t[e].namespace);if(!i)throw'Unknown function "'+t[e].namespace+'"';var r=o(t[e].args||[]);if(r){window.console.log(e,"wired");var a=t[e].factory?i:i.apply(i,r);n.di.addInstance(e,a,t[e].factory,t[e].args||[]),t[e].extension&&(n=n.object.extend(n,a))}else c[e]=t[e]});var i=n.object.keys(c);if(i.length!==t.length&&i.length>0)a(c);else if(0!==i.length)throw"Make sure you don't have circular dependencies, Unable to resolve the following instances: "+i.join(", ")},f=function(t){n.object.keys(t).forEach(function(n){t[n].init&&c(n,t[n].init.func,t[n].init.args)})},u=function(n){"complete"!==document.readyState?window.setTimeout(function(){u(n)},100):n.forEach(function(n){n.instance?c(n.instance,n.func,n.args):n.func&&c(null,n.func,n.args)})},s=function(){var t=n.config.context.dependencies[n.config.mode],e=n.async.seqLatch(t.sync,function(t){n.loadScript(t,e.next)},function(){var e=n.async.latch(t.async.length,function(){window.console.log("wire instances"),a(n.config.context.instances),window.console.log("init instances"),f(n.config.context.instances),window.console.log("start instances"),u(n.config.context.start)},"dependencies");t.async.forEach(function(t){n.loadScript(t,e.countDown)})});e.next()},l=function(t){for(var e=t.pop(),o=[];e;)n.object.get(window,e.namespace)?n.config=n.object.extend(n.config,n.object.get(window,e.namespace)()):o.push(e),e=t.pop();if(0!==o.length){var c=n.async.latch(o.length,function(){l(o)},"imports");o.forEach(function(t){n.loadScript(t.url,c.countDown)})}else s()},d=function(t){n.di.addInstance("ioc",n),n.config=t,n.config.mode=n.url.query().env||"default",t.exposeIoc&&(window.ioc=n),n.config.imports?l(JSON.parse(JSON.stringify(n.config.imports))):s()};return{di:{loadConfig:d,getInstance:r,addInstance:i}}};